<!DOCTYPE html>
<html lang="tr">
<head>
<script>
  // Gƒ∞Rƒ∞≈û KONTROL√ú
  if (localStorage.getItem("mutenaGiris") !== "true") {
    var password = prompt("L√ºtfen giri≈ü ≈üifresini yazƒ±n:");
    if (password === "mutena123") {
      localStorage.setItem("mutenaGiris", "true");
      alert("Giri≈ü ba≈üarƒ±lƒ±!");
    } else {
      alert("Hatalƒ± ≈üifre!");
      window.location.href = "https://google.com";
    }
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mutena Dijital Adisyon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- MODERN UI DEƒûƒ∞≈ûKENLERƒ∞ --- */
        :root {
            --primary: #1e293b;
            --secondary: #34495e;
            --accent: #f39c12;
            --accent-hover: #d35400;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-light: #636e72;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-hard: 0 4px 10px rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; 
            background-color: var(--bg-body); color: var(--text-main);
            -webkit-tap-highlight-color: transparent; padding-top: 75px; padding-bottom: 30px;
        }

        header { 
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            color: #f1c40f; padding: 15px 20px; text-align: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: fixed; 
            top: 0; left: 0; width: 100%; z-index: 1000; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        h1 { margin: 0; font-weight: 800; font-size: 20px; letter-spacing: 1px; text-transform: uppercase; }
        
        /* Bƒ∞LDƒ∞Rƒ∞M Zƒ∞Lƒ∞ (SAƒû √úST) */
        .notification-bell {
            position: absolute;
            right: 15px;
            top: 15px; /* Header i√ßinde */
            font-size: 22px;
            color: #f1c40f;
            cursor: pointer;
            display: none; /* Varsayƒ±lan gizli */
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 4px 7px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid #1e293b;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .mode-selector { 
            display: flex; flex-direction: column; justify-content: center; gap: 20px; padding: 30px; 
            min-height: 90vh; align-items: center; 
            background: linear-gradient(135deg, #1e293b, #2c3e50); margin-top: -75px;
        }
        .mode-btn { 
            width: 100%; max-width: 380px; padding: 25px; font-size: 18px; cursor: pointer; border: none; 
            border-radius: var(--radius-lg); color: white; font-weight: 700; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
        }
        .mode-btn:active { transform: scale(0.97); }
        .mode-btn i { font-size: 24px; opacity: 0.9; }
        
        .btn-garson-alt { background: linear-gradient(135deg, #f39c12, #d35400); }
        .btn-garson-ust { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .btn-mutfak { background: linear-gradient(135deg, #e74c3c, #c0392b); } 
        .btn-kasa { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-paket { background: linear-gradient(135deg, #3498db, #2980b9); }

        #garson-panel, #kasa-panel, #mutfak-panel, #rapor-panel, #paket-panel { 
            display: none; padding: 15px; max-width: 1200px; margin: 0 auto; padding-bottom: 140px;
        }
        
        .garson-header { 
            position: sticky; top: 75px; z-index: 800; background: var(--bg-body); 
            padding: 10px 0; margin-bottom: 10px;
        }
        .garson-controls { display: flex; gap: 10px; }
        
        .table-select, .search-input { 
            flex: 1; padding: 15px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); 
            font-weight: 600; background: white; color: var(--text-main);
            box-shadow: var(--shadow-soft); outline: none; appearance: none;
            transition: border-color 0.3s;
        }
        .table-select:focus, .search-input:focus { border-color: var(--info-color); }
        
        option.busy-table { background-color: #fff3cd; color: #d35400; font-weight: bold; }
        
        #masaDurumBilgisi {
            background-color: #fff8e1; color: #856404; padding: 15px; margin-top: 10px; 
            border-radius: var(--radius-md); border-left: 5px solid #ffc107; 
            display: none; font-size: 14px; box-shadow: var(--shadow-soft);
        }

        /* --- MUTFAK EKRANI (3 S√úTUN) --- */
        .kitchen-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; align-items: start; }
        @media (max-width: 900px) { .kitchen-grid { grid-template-columns: 1fr; } }
        .kitchen-col { background: #e2e8f0; padding: 10px; border-radius: var(--radius-md); min-height: 300px; }
        .kitchen-col-title { text-align: center; font-weight: 800; color: var(--primary); background: white; padding: 10px; border-radius: var(--radius-sm); margin-bottom: 10px; box-shadow: var(--shadow-soft); border-bottom: 4px solid transparent; }
        .col-alt .kitchen-col-title { border-color: var(--accent); color: #d35400; }
        .col-ust .kitchen-col-title { border-color: #8e44ad; color: #8e44ad; }
        .col-paket .kitchen-col-title { border-color: #3498db; color: #2980b9; }

        .kitchen-card { border-left: 6px solid #d35400; background: #fffcf5; margin-bottom: 10px; transition: all 0.3s ease; }
        .kitchen-item-ready { color: #95a5a6; text-decoration: line-through; opacity: 0.6; font-size: 15px; }
        .kitchen-item-new { color: var(--primary); font-weight: 800; font-size: 19px; padding: 5px 0; }
        
        .order-done { opacity: 0.9; border-left-color: var(--success) !important; background-color: #dcfce7 !important; }
        
        .card-collapsed .order-list-compact, .card-collapsed .ready-btn, .card-collapsed .order-details-wrapper { display: none !important; }
        .card-collapsed { padding: 10px !important; background: #e0e0e0 !important; border-left-color: #7f8c8d !important; opacity: 0.7; }
        
        .toggle-icon { cursor: pointer; float: right; font-size: 18px; color: #555; padding: 5px; }
        .toggle-icon:hover { color: #000; }

        .ready-btn { width: 100%; background: var(--success); color: white; padding: 15px; border: none; border-radius: var(--radius-md); font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }

        /* --- Dƒ∞ƒûER STƒ∞LLER --- */
        .customer-form { background: white; padding: 15px; border-radius: var(--radius-md); box-shadow: var(--shadow-soft); margin-bottom: 15px; border-left: 5px solid #3498db; }
        .customer-input { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background-color: white !important; color: #2d3436 !important; opacity: 1 !important;}
        
        .category-wrapper { margin-bottom: 12px; }
        .category-title { background: white; color: var(--primary); padding: 18px 20px; border-radius: var(--radius-md); font-weight: 700; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-soft); border: 1px solid transparent; transition: all 0.2s; }
        .category-items { display: none; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px 5px; animation: fadeIn 0.3s ease; }
        @media (min-width: 600px) { .category-items { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-item { background: white; padding: 15px; border-radius: var(--radius-md); text-align: center; border: 1px solid #f1f5f9; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; justify-content: space-between; min-height: 100px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .menu-item:active { transform: scale(0.95); border-color: var(--accent); background-color: #fffbf2; }
        .menu-name { font-weight: 600; font-size: 15px; color: var(--text-main); margin-bottom: 8px; line-height: 1.3;}
        .menu-price { color: var(--accent-hover); font-weight: 800; font-size: 17px; }
        
        .cart-section { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 20px; box-shadow: 0 -5px 30px rgba(0,0,0,0.1); z-index: 999; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); }
        .cart-total-info { font-size: 16px; font-weight: 700; color: var(--primary); }
        .cart-total-info span { color: var(--danger); font-size: 20px; }
        .cart-btn { background: linear-gradient(to right, #27ae60, #2ecc71); border: none; color: white; padding: 14px 30px; border-radius: 50px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); transition: transform 0.2s; }
        .cart-btn:active { transform: scale(0.95); }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--bg-card); width: 90%; max-width: 450px; margin: 60px auto; padding: 25px; border-radius: var(--radius-lg); max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 15px 50px rgba(0,0,0,0.3); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-list { list-style: none; padding: 0; margin-bottom: 20px; }
        .modal-list li { display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.3fr; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; gap: 10px; }
        .portion-select { padding: 8px 5px; border-radius: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: 600; font-size: 12px; width: 100%; outline: none; }
        .del-item { background: #ffebee; color: var(--danger); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .note-area { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: var(--radius-md); box-sizing: border-box; font-family: inherit; margin-bottom: 15px; background: #f8fafc; outline: none; }
        
        .action-btn-full { width: 100%; padding: 15px; border: none; border-radius: var(--radius-md); font-weight: 700; font-size: 16px; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .action-btn-full:active { transform: scale(0.98); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2); }
        .btn-cancel { background: var(--danger); color: white; margin-top: 10px; }
        .btn-close { background: #e2e8f0; color: var(--text-light); }

        .floor-section { margin-bottom: 30px; }
        .floor-title { font-size: 18px; font-weight: 800; color: white; padding: 12px 20px; border-radius: var(--radius-md); margin-bottom: 15px; display: inline-block; box-shadow: var(--shadow-soft); }
        .bg-alt { background: var(--accent); }
        .bg-ust { background: #8e44ad; }
        .bg-paket { background: #3498db; }

        .order-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .order-card { background: white; border-left: 6px solid #ccc; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-soft); display: flex; flex-direction: column; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card-alt { border-left-color: var(--accent); }
        .card-ust { border-left-color: #8e44ad; }
        .card-paket { border-left-color: #3498db; background: #f0f8ff; }

        .order-header { display: flex; justify-content: space-between; font-weight: 800; font-size: 18px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px; color: var(--primary); }
        .order-list-container { max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px;}
        .order-list-compact li { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 5px; }
        
        .hazir-urun { color: #94a3b8; text-decoration: line-through; }
        .hazir-etiket { color: var(--success); font-size: 11px; font-weight: bold; background: #dcfce7; padding: 3px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
        .total-price-compact { text-align: right; font-size: 20px; font-weight: 800; color: var(--success); margin-top: auto; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .edit-btn, .pay-btn { flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm); font-weight: 700; cursor: pointer; color: white; font-size: 14px; transition: opacity 0.2s;}
        .edit-btn { background: #f39c12; } 
        .pay-btn { background: #c0392b; }
        .edit-btn:hover, .pay-btn:hover { opacity: 0.9; }

        .mini-cart-container { position: fixed; bottom: 85px; left: 15px; right: 15px; background: rgba(255,255,255,0.98); max-height: 150px; overflow-y: auto; z-index: 990; display: none; padding: 10px; border-radius: var(--radius-md); box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #e2e8f0; }
        .mini-cart-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: var(--text-main); font-weight: 500;}
        .mini-cart-item:last-child { border-bottom: none; }
        .mini-cart-remove { color: var(--danger); cursor: pointer; font-weight: bold; padding: 0 5px; }

        #kasaSifreInput { border: 2px solid #cbd5e1; border-radius: var(--radius-md); padding: 15px; font-size: 24px; width: 80%; letter-spacing: 5px; margin-bottom: 20px; outline: none; text-align: center; }
        .back-btn { background: #94a3b8; color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;}
        
        .menu-manage-table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; border-radius: var(--radius-sm); overflow: hidden; box-shadow: var(--shadow-soft); }
        .menu-manage-table th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        .menu-manage-table td { border-bottom: 1px solid #f1f5f9; padding: 12px; color: var(--text-main); }
        .drag-handle { cursor: grab; text-align: center; color: #94a3b8; font-size: 18px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    </style>
</head>
<body>

<header>
    <h1>MUTENA ADƒ∞SYON</h1>
    <div id="notificationBell" class="notification-bell" onclick="showReadyOrdersModal()">
        <i class="fas fa-bell"></i>
        <div id="notificationBadge" class="notification-badge" style="display:none;">0</div>
    </div>
</header>

<div class="mode-selector" id="giris-ekrani">
    <button class="mode-btn btn-garson-alt" onclick="openMode('garson-alt')">
        <i class="fas fa-utensils"></i> ALT KAT GARSON (61-68)
    </button>
    <button class="mode-btn btn-garson-ust" onclick="openMode('garson-ust')">
        <i class="fas fa-layer-group"></i> √úST KAT GARSON (1-18)
    </button>
    <button class="mode-btn btn-paket" onclick="openMode('paket')">
        <i class="fas fa-motorcycle"></i> üõµ PAKET SERVƒ∞S
    </button>
    <button class="mode-btn btn-mutfak" onclick="openMode('mutfak')">
        <i class="fas fa-fire-alt"></i> MUTFAK EKRANI
    </button>
    <button class="mode-btn btn-kasa" onclick="openMode('kasa')">
        <i class="fas fa-cash-register"></i> KASA Gƒ∞Rƒ∞≈ûƒ∞ üîí
    </button>
</div>

<div id="passwordModal" class="modal" style="z-index: 2000;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-lock" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Y√∂netici Giri≈üi</h3>
        <input type="password" id="kasaSifreInput" placeholder="****" inputmode="numeric">
        <button class="action-btn-full btn-success" onclick="sifreKontrolEt()">Gƒ∞Rƒ∞≈û YAP</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="passwordChangeModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-key" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Kasa ≈ûifresini Deƒüi≈ütir</h3>
        <input type="password" id="eskiSifreInput" placeholder="Mevcut ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        <input type="text" id="yeniSifreInput" placeholder="Yeni ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        <button class="action-btn-full btn-success" onclick="sifreyiVeritabanindaGuncelle()">KAYDET VE DEƒûƒ∞≈ûTƒ∞R</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordChangeModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="garson-panel">
    <button class="back-btn" onclick="location.reload()"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
    <div class="garson-header">
        <div class="garson-controls">
            <select id="masaSecimi" class="table-select" onchange="masaKontrol()"></select>
            <input type="text" id="urunArama" class="search-input" placeholder="üîç √úr√ºn Ara..." onkeyup="urunAra()">
        </div>
        <div id="masaDurumBilgisi"></div>
    </div>
    <div id="menuContainer" style="padding-bottom: 20px;"></div>
    <div id="miniCart" class="mini-cart-container"></div>
    <div class="cart-section" onclick="sepetiAc()">
        <div class="cart-total-info">Toplam: <span id="sepetToplam">0</span> ‚Ç∫</div>
        <button class="cart-btn">SEPETƒ∞ ONAYLA <i class="fas fa-check"></i></button>
    </div>
</div>

<div id="paket-panel">
    <button class="back-btn" onclick="location.reload()" style="background:#3498db;"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
    <div style="background:white; padding:15px; position:sticky; top:75px; z-index:800; box-shadow:var(--shadow-soft);">
        <h3 style="margin:0 0 10px 0; color:#3498db;"><i class="fas fa-motorcycle"></i> Paket Servis</h3>
        <div class="customer-form">
            <div style="display:flex; gap:10px;">
                <input type="tel" id="paketTel" class="customer-input" placeholder="Telefon (5XXXXXXXXX)" onblur="musteriAra()">
                <button onclick="musteriAra()" style="height:46px; background:#3498db; color:white; border:none; border-radius:8px; width:60px;"><i class="fas fa-search"></i></button>
            </div>
            <input type="text" id="paketIsim" class="customer-input" placeholder="M√º≈üteri Adƒ±">
            <textarea id="paketAdres" class="customer-input" rows="2" placeholder="Adres"></textarea>
        </div>
        <input type="text" id="paketUrunArama" class="search-input" placeholder="üîç Men√ºde Ara..." onkeyup="urunAraPaket()" style="width:100%; box-sizing:border-box;">
    </div>
    <div id="paketMenuContainer" style="padding-bottom: 120px; padding-top:10px;"></div>
    <div id="paketMiniCart" class="mini-cart-container"></div>
    <div class="cart-section" onclick="sepetiAcPaket()">
        <div class="cart-total-info">Toplam: <span id="paketSepetToplam">0</span> ‚Ç∫</div>
        <button class="cart-btn" style="background:linear-gradient(to right, #3498db, #2980b9);">Sƒ∞PARƒ∞≈ûƒ∞ TAMAMLA <i class="fas fa-check"></i></button>
    </div>
</div>

<div id="sepetModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
            <i class="fas fa-shopping-basket"></i> Sipari≈ü √ñzeti
        </h3>
        <ul id="sepetListesi" class="modal-list"></ul>
        <div id="kuryeSecimDiv" style="display:none; margin-bottom:15px; background:#f0f8ff; padding:10px; border-radius:8px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">üõµ Kurye Se√ß:</label>
            <select id="kuryeSecimi" class="table-select" style="width:100%;">
                <option value="Ahmet">Ahmet</option>
                <option value="Mehmet">Mehmet</option>
                <option value="Diger">Diƒüer</option>
            </select>
        </div>
        <textarea id="siparisNotu" class="note-area" rows="2" placeholder="Not ekle (√ñrn: Acƒ±sƒ±z, Soƒüansƒ±z)..."></textarea>
        <button class="action-btn-full btn-success" onclick="firebasedenGonder()">‚úÖ Sƒ∞PARƒ∞≈ûƒ∞ G√ñNDER</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('sepetModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="mutfak-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="font-weight:800; color:#d35400; font-size:24px; letter-spacing:1px;">
            <i class="fas fa-fire"></i> MUTFAK EKRANI
        </div>
    </div>
    <div class="kitchen-grid">
        <div class="kitchen-col col-alt">
            <div class="kitchen-col-title">‚¨áÔ∏è ALT KAT (61-68)</div>
            <div id="list-alt" class="order-container" style="display:flex; flex-direction:column;"></div>
        </div>
        <div class="kitchen-col col-ust">
            <div class="kitchen-col-title">‚¨ÜÔ∏è √úST KAT (1-18)</div>
            <div id="list-ust" class="order-container" style="display:flex; flex-direction:column;"></div>
        </div>
        <div class="kitchen-col col-paket">
            <div class="kitchen-col-title">üõµ PAKET SERVƒ∞S</div>
            <div id="list-paket" class="order-container" style="display:flex; flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="readyOrdersModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--success); border-bottom:2px solid #eee; padding-bottom:10px;">
            <i class="fas fa-bell"></i> Hazƒ±r Sipari≈üler
        </h3>
        <div id="readyOrdersList" class="order-container" style="display:flex; flex-direction:column;"></div>
        <button class="action-btn-full btn-close" onclick="document.getElementById('readyOrdersModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Sipari≈üi D√ºzenle</h3>
        <h4 id="editMasaBaslik" style="color:var(--text-light); margin-bottom:15px;"></h4>
        
        <div id="editPaketBilgi" style="display:none; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
             <label style="font-weight:bold; color:#3498db;">M√º≈üteri & Adres D√ºzenle:</label>
             <input type="text" id="editPaketIsim" class="table-select" style="width:100%; margin-bottom:5px; box-sizing:border-box;">
             <textarea id="editPaketAdres" class="note-area" rows="2" style="background:white;"></textarea>
        </div>

        <ul id="editList" class="modal-list" style="max-height:200px; overflow-y:auto;"></ul>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <select id="editMenuSelect" class="table-select" style="padding:10px;"></select>
            <button onclick="editUrunEkle()" style="padding:10px 20px; background:var(--info-color); color:white; border:none; border-radius:8px; font-weight:bold;">EKLE</button>
        </div>
        <div style="text-align:right; font-weight:bold; margin:20px 0; font-size:18px; color:var(--success);">Yeni Toplam: <span id="editTotal">0</span> ‚Ç∫</div>
        <button class="action-btn-full btn-success" onclick="editKaydet()">DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
        <button class="action-btn-full btn-cancel" onclick="editSiparisiIptal()">üóëÔ∏è Sƒ∞PARƒ∞≈ûƒ∞ KOMPLE ƒ∞PTAL ET</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('editModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="menuManageModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
        <h3>Men√º Y√∂netimi</h3>
        <select id="filterCategory" class="table-select" style="padding:10px; margin-bottom:15px;" onchange="renderMenuManageTable()">
            <option value="all">üîç T√úM KATEGORƒ∞LER</option>
        </select>
        <div style="max-height:50vh; overflow-y:auto; border-radius:var(--radius-sm); border:1px solid #e2e8f0;">
            <table class="menu-manage-table">
                <thead><tr><th style="width:40px;">‚ò∞</th><th>Kategori</th><th>√úr√ºn</th><th>Fiyat</th><th>Sil</th></tr></thead>
                <tbody id="menuManageBody"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="addNewMenuRow()" class="action-btn-full" style="background:var(--info-color); color:white;">+ YENƒ∞ √úR√úN</button>
            <button onclick="addNewCategory()" class="action-btn-full" style="background:#9b59b6; color:white;">+ YENƒ∞ KATEGORƒ∞</button>
        </div>
        <button class="action-btn-full btn-success" style="margin-top:10px;" onclick="saveMenuChanges()">KAYDET VE √áIK</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('menuManageModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="kasa-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="display:flex; gap:10px;">
             <button onclick="openPasswordChangeModal()" style="background:#e67e22; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-key"></i> ≈ûƒ∞FRE</button>
            <button onclick="openMenuManager()" style="background:#3498db; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-edit"></i> MEN√ú</button>
            <button onclick="raporlariAc()" style="background:#9b59b6; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-chart-pie"></i> RAPOR</button>
        </div>
    </div>
    <div id="kasaContainer"></div>
</div>

<div id="rapor-panel">
    <button class="back-btn" onclick="openMode('kasa-authorized')" style="margin-bottom:20px;">‚Üê Geri</button>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
        <div class="report-card" style="background:white; padding:15px; border-radius:10px; box-shadow:var(--shadow-soft);">
            <div style="color:var(--text-light); font-weight:600;">BUG√úNK√ú Cƒ∞RO</div>
            <div class="report-value" id="gunlukCiro" style="font-size:24px; font-weight:bold; color:var(--success);">0 ‚Ç∫</div>
        </div>
        <div class="report-card" style="background:white; padding:15px; border-radius:10px; box-shadow:var(--shadow-soft);">
            <div style="color:var(--text-light); font-weight:600;">ƒ∞≈ûLEM SAYISI</div>
            <div class="report-value" id="toplamMasa" style="font-size:24px; font-weight:bold; color:var(--primary);">0</div>
        </div>
    </div>
    <div class="report-card" style="text-align:left; background:white; padding:15px; border-radius:10px; box-shadow:var(--shadow-soft); margin-bottom:20px;">
        <h4 style="margin-top:0; border-bottom:2px solid #f1f5f9; padding-bottom:10px; color:#3498db;"><i class="fas fa-motorcycle"></i> Kurye Tahsilat Durumu</h4>
        <div id="kuryeRaporListesi"></div>
    </div>
    <div class="report-card" style="text-align:left; background:white; padding:15px; border-radius:10px; box-shadow:var(--shadow-soft);">
        <h4 style="margin-top:0; border-bottom:2px solid #f1f5f9; padding-bottom:10px;">Satƒ±lan √úr√ºnler</h4>
        <ul id="satilanUrunlerListesi" style="padding-left:0; margin:0; font-size:14px; list-style:none;"></ul>
    </div>
    <button class="action-btn-full btn-cancel" onclick="raporlariSifirla()"><i class="fas fa-trash-alt"></i> Cƒ∞ROYU SIFIRLA</button>
</div>

<script>
    // SES DOSYASI (Kƒ±sa 'Ding' Sesi - Base64)
    const notificationSound = new Audio("data:audio/wav;base64,UklGRl9vT1ZAVXpp..."); // Dosya boyutu b√ºy√ºk olmasƒ±n diye kƒ±sa tuttum, a≈üaƒüƒ±da kod i√ßinde ger√ßek ses var.
    
    // Basit bir bip sesi (Tarayƒ±cƒ± uyumlu)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playNotificationSound() {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = "sine";
        osc.frequency.value = 523.25; // C5 Nota
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => { osc.stop(); }, 200);
        setTimeout(() => { 
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.type = "sine";
            osc2.frequency.value = 659.25; // E5 Nota
            gain2.gain.value = 0.1;
            osc2.start();
            setTimeout(() => { osc2.stop(); }, 400);
        }, 250);
    }

    const TABLES_ALT = ["Masa 61", "Masa 62", "Masa 63", "Masa 64", "Masa 65", "Masa 66", "Masa 67", "Masa 68"];
    const TABLES_UST = Array.from({length: 18}, (_, i) => `Masa ${i + 1}`); 
    let CATEGORIES = ["G√úN√úN YEMEKLERƒ∞", "√áORBALAR", "IZGARALAR", "Pƒ∞DELER", "KEBAPLAR", "ƒ∞√áECEKLER", "TATLI"];
    
    let currentMenu = []; 
    let sepet = [];
    let activeOrders = {};
    let editingOrderKey = null;
    let editingItems = [];
    let isPaketMode = false;
    let collapsedStates = {};
    let currentUserMode = ""; // 'alt', 'ust', 'paket'
    let previousReadyCount = 0; // Bildirim takibi i√ßin

    function openMode(mode) {
        if (mode === 'kasa') {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('kasaSifreInput').value = '';
            document.getElementById('kasaSifreInput').focus();
            return;
        }
        
        ['giris-ekrani','garson-panel','kasa-panel','mutfak-panel','rapor-panel','paket-panel'].forEach(id => {
            document.getElementById(id).style.display = "none";
        });
        
        // Bildirim Zili Y√∂netimi
        const bell = document.getElementById("notificationBell");
        if(mode === 'garson-alt' || mode === 'garson-ust' || mode === 'paket') {
            bell.style.display = "block";
        } else {
            bell.style.display = "none";
        }

        isPaketMode = false;
        currentUserMode = ""; // Sƒ±fƒ±rla

        if (mode === 'garson-alt') {
            document.getElementById("garson-panel").style.display = "block";
            currentUserMode = 'alt';
            updateTableSelect(TABLES_ALT);
            window.fetchMenu(); window.garsonMasalariDinle();
        } 
        else if (mode === 'garson-ust') {
            document.getElementById("garson-panel").style.display = "block";
            currentUserMode = 'ust';
            updateTableSelect(TABLES_UST);
            window.fetchMenu(); window.garsonMasalariDinle();
        }
        else if (mode === 'paket') {
            document.getElementById("paket-panel").style.display = "block";
            currentUserMode = 'paket';
            isPaketMode = true;
            window.fetchMenu();
            setTimeout(() => window.renderMenu(currentMenu), 500);
        }
        else if (mode === 'mutfak') {
            document.getElementById("mutfak-panel").style.display = "block";
            window.mutfakSiparisleriDinle();
        }
        else if (mode === 'kasa-authorized') { 
            document.getElementById("kasa-panel").style.display = "block";
            window.siparisleriGetir(); window.fetchMenu();
        }
        
        // Mod deƒüi≈ütiƒüinde bildirimleri hemen kontrol et
        if(window.checkReadyNotifications) window.checkReadyNotifications();
    }

    function updateTableSelect(tables) {
        const select = document.getElementById("masaSecimi");
        select.innerHTML = '<option value="">MASA SE√áƒ∞Nƒ∞Z...</option>';
        tables.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t; opt.text = t; select.appendChild(opt);
        });
        window.garsonMasalariDinle();
    }

    window.sifreKontrolEt = function() {
        const input = document.getElementById("kasaSifreInput").value;
        const gecerliSifre = window.currentKasaSifre || "1234";
        if(input === gecerliSifre) {
            document.getElementById('passwordModal').style.display = 'none';
            openMode('kasa-authorized');
        } else {
            alert("‚õî Hatalƒ± ≈ûifre!");
            document.getElementById("kasaSifreInput").value = "";
        }
    }

    window.openPasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').style.display = 'block';
        document.getElementById('eskiSifreInput').value = '';
        document.getElementById('yeniSifreInput').value = '';
    }

    window.sifreyiVeritabanindaGuncelle = function() {
        const eski = document.getElementById('eskiSifreInput').value;
        const yeni = document.getElementById('yeniSifreInput').value;
        const mevcut = window.currentKasaSifre || "1234";
        if(eski !== mevcut) { alert("‚ùå Mevcut ≈üifre yanlƒ±≈ü!"); return; }
        if(yeni.length < 4) { alert("‚ö†Ô∏è ≈ûifre en az 4 hane olmalƒ±."); return; }
        window.saveNewPasswordToFirebase(yeni);
    }

    function masaKontrol() {
        const masa = document.getElementById("masaSecimi").value;
        const durumDiv = document.getElementById("masaDurumBilgisi");
        const aktifSiparis = Object.values(activeOrders).find(o => o.masa === masa);
        if (aktifSiparis) {
            let icerik = "<strong>Bu Masadaki √úr√ºnler:</strong><br>";
            if(aktifSiparis.urunler) aktifSiparis.urunler.forEach(u => icerik += `- ${u.ad}<br>`);
            icerik += `<br><strong>Toplam: ${aktifSiparis.toplam} ‚Ç∫</strong>`;
            durumDiv.innerHTML = icerik;
            durumDiv.style.display = "block";
        } else { durumDiv.style.display = "none"; }
    }

    window.renderMenu = function(menuList) {
        currentMenu = menuList; 
        const containerID = isPaketMode ? "paketMenuContainer" : "menuContainer";
        const container = document.getElementById(containerID);
        if(!container) return;
        container.innerHTML = "";
        
        const grouped = {};
        menuList.forEach(item => {
            if(!grouped[item.cat]) grouped[item.cat] = [];
            grouped[item.cat].push(item);
        });

        for (const [kategori, urunler] of Object.entries(grouped)) {
            const catBlock = document.createElement("div");
            catBlock.className = "category-wrapper";

            const title = document.createElement("div");
            title.className = "category-title";
            title.innerHTML = `<span>${kategori}</span> <span style="font-size:12px">‚ñº</span>`;
            
            const itemsContainer = document.createElement("div");
            itemsContainer.className = "category-items"; 
            
            urunler.forEach(urun => {
                const div = document.createElement("div");
                div.className = "menu-item";
                div.innerHTML = `<div class="menu-name">${urun.ad}</div><div class="menu-price">${urun.fiyat} ‚Ç∫</div>`;
                div.onclick = () => sepeteEkle(urun);
                itemsContainer.appendChild(div);
            });

            title.onclick = function() {
                const isCurrentlyOpen = itemsContainer.style.display === "grid";
                if(!isPaketMode) {
                     document.querySelectorAll('#' + containerID + ' .category-items').forEach(el => el.style.display = 'none');
                     document.querySelectorAll('#' + containerID + ' .category-title span:last-child').forEach(el => el.innerText = '‚ñº');
                }
                if (!isCurrentlyOpen) {
                    itemsContainer.style.display = "grid";
                    this.querySelector('span:last-child').innerText = "‚ñ≤";
                } else {
                    itemsContainer.style.display = "none";
                    this.querySelector('span:last-child').innerText = "‚ñº";
                }
            };
            catBlock.appendChild(title);
            catBlock.appendChild(itemsContainer);
            container.appendChild(catBlock);
        }
    }

    window.urunAra = function() { aramaMotoru("urunArama", "menuContainer"); }
    window.urunAraPaket = function() { aramaMotoru("paketUrunArama", "paketMenuContainer"); }

    function aramaMotoru(inputId, containerId) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const container = document.getElementById(containerId);
        const wrappers = container.getElementsByClassName("category-wrapper");
        if (filter === "") { 
            for(let w of wrappers) { w.style.display = ""; w.getElementsByClassName("category-items")[0].style.display = "none"; }
            return; 
        }
        for (let i = 0; i < wrappers.length; i++) {
            const wrapper = wrappers[i];
            const itemsContainer = wrapper.getElementsByClassName("category-items")[0];
            const items = itemsContainer.getElementsByClassName("menu-item");
            let hasMatch = false;
            for (let j = 0; j < items.length; j++) {
                const item = items[j];
                const name = item.getElementsByClassName("menu-name")[0];
                if (name.innerText.toUpperCase().indexOf(filter) > -1) { item.style.display = "flex"; hasMatch = true; } else { item.style.display = "none"; }
            }
            if (hasMatch) { wrapper.style.display = ""; itemsContainer.style.display = "grid"; } else { wrapper.style.display = "none"; }
        }
    }

    function sepeteEkle(urun) { 
        let eklenecekUrun = { ...urun, porsiyon: 1, baseFiyat: urun.fiyat };
        sepet.push(eklenecekUrun); sepetiGuncelle(); 
    }

    window.porsiyonDegistir = function(index, yeniPorsiyon) {
        let urun = sepet[index];
        urun.porsiyon = parseFloat(yeniPorsiyon);
        urun.fiyat = urun.baseFiyat * urun.porsiyon;
        let temizAd = urun.ad.split(" (")[0]; 
        if (urun.porsiyon !== 1) { urun.ad = `${temizAd} (${urun.porsiyon} Pors.)`; } else { urun.ad = temizAd; }
        sepetiGuncelle();
    }

    function sepetiGuncelle() {
        const toplamSpan = isPaketMode ? document.getElementById("paketSepetToplam") : document.getElementById("sepetToplam");
        const miniCart = isPaketMode ? document.getElementById("paketMiniCart") : document.getElementById("miniCart");
        const detayListe = document.getElementById("sepetListesi");
        detayListe.innerHTML = ""; miniCart.innerHTML = ""; let toplam = 0;
        if (sepet.length > 0) {
            miniCart.style.display = "block"; 
            const ul = document.createElement("ul"); ul.className = "mini-cart-list";
            sepet.forEach((item, index) => {
                toplam += item.fiyat;
                let optionsHTML = "";
                for (let p = 1; p <= 5; p += 0.5) {
                    let selected = item.porsiyon === p ? "selected" : "";
                    optionsHTML += `<option value="${p}" ${selected}>${p}</option>`;
                }
                const li = document.createElement("li");
                li.innerHTML = `<span>${item.ad.split(" (")[0]}</span> <select class="portion-select" onchange="porsiyonDegistir(${index}, this.value)">${optionsHTML}</select><span style="font-weight:bold; color:var(--danger); text-align:right;">${item.fiyat}‚Ç∫</span> <div class="del-item" onclick="sepettenCikar(${index})"><i class="fas fa-times"></i></div>`;
                detayListe.appendChild(li);
                const miniLi = document.createElement("li");
                miniLi.className = "mini-cart-item";
                miniLi.innerHTML = `<span>${item.ad}</span> <div class="mini-cart-remove" onclick="sepettenCikar(${index})"><i class="fas fa-times"></i></div>`;
                ul.appendChild(miniLi);
            });
            miniCart.appendChild(ul);
        } else { miniCart.style.display = "none"; }
        toplamSpan.textContent = toplam;
    }

    function sepetiAc() { if(sepet.length > 0) { document.getElementById("sepetModal").style.display = "block"; document.getElementById("kuryeSecimDiv").style.display = "none"; }}
    function sepetiAcPaket() { if(sepet.length > 0) { document.getElementById("sepetModal").style.display = "block"; document.getElementById("kuryeSecimDiv").style.display = "block"; }}
    function sepettenCikar(index) { sepet.splice(index, 1); sepetiGuncelle(); if(sepet.length === 0) document.getElementById("sepetModal").style.display = "none"; }

    function firebasedenGonder() {
        if(!window.sendOrder) { alert("Sistem bekleniyor..."); return; }
        let masa, kurye, musteriTel, musteriIsim, musteriAdres;
        if (isPaketMode) {
            musteriTel = document.getElementById("paketTel").value;
            musteriIsim = document.getElementById("paketIsim").value;
            musteriAdres = document.getElementById("paketAdres").value;
            kurye = document.getElementById("kuryeSecimi").value;
            if(!musteriTel || musteriTel.length < 3) { alert("L√ºtfen telefon girin!"); return; }
            if(!musteriIsim) { alert("L√ºtfen isim girin!"); return; }
            if(!musteriAdres) { alert("L√ºtfen adres girin!"); return; }
            window.saveCustomerToFirebase(musteriTel, musteriIsim, musteriAdres);
            masa = `PAKET - ${musteriIsim}`;
        } else {
            masa = document.getElementById("masaSecimi").value;
            if (!masa) { alert("Masa se√ßilmedi!"); return; }
        }
        const not = document.getElementById("siparisNotu").value;
        const existingKey = !isPaketMode ? Object.keys(activeOrders).find(key => activeOrders[key].masa === masa) : null;
        if (existingKey) {
            const oldOrder = activeOrders[existingKey];
            const newItems = oldOrder.urunler ? [...oldOrder.urunler, ...sepet] : [...sepet];
            const newTotal = newItems.reduce((a, b) => a + b.fiyat, 0);
            window.updateOrderInFirebase(existingKey, newItems, newTotal, 'hazirlaniyor', () => resetAfterSend());
        } else {
            const orderData = { masa: masa, urunler: sepet, not: not, isPaket: isPaketMode, kurye: isPaketMode ? kurye : null, musteri: isPaketMode ? { tel: musteriTel, isim: musteriIsim, adres: musteriAdres } : null };
            window.sendOrder(orderData, () => resetAfterSend());
        }
    }

    function resetAfterSend() {
        sepet = []; sepetiGuncelle(); document.getElementById("sepetModal").style.display = "none"; document.getElementById("siparisNotu").value = "";
        if(isPaketMode) {
            document.getElementById("paketTel").value = ""; document.getElementById("paketIsim").value = ""; document.getElementById("paketAdres").value = "";
        } else { document.getElementById("masaSecimi").value = ""; document.getElementById("masaDurumBilgisi").style.display = "none"; }
        window.scrollTo(0,0);
    }

    window.musteriAra = function() {
        const tel = document.getElementById("paketTel").value;
        if(tel.length > 2) {
            window.findCustomerInFirebase(tel, (data) => {
                const isimInput = document.getElementById("paketIsim"); const adresInput = document.getElementById("paketAdres");
                if(data) { isimInput.value = data.isim; adresInput.value = data.adres; } 
            });
        }
    }

    window.siparisDuzenle = function(key) {
        const order = activeOrders[key]; if(!order) return;
        editingOrderKey = key; editingItems = [...order.urunler]; 
        const editPaketDiv = document.getElementById("editPaketBilgi");
        if(order.isPaket && order.musteri) {
            editPaketDiv.style.display = "block";
            document.getElementById("editPaketIsim").value = order.musteri.isim;
            document.getElementById("editPaketAdres").value = order.musteri.adres;
        } else {
            editPaketDiv.style.display = "none";
        }
        initEditDropdown(); renderEditList(); document.getElementById("editModal").style.display = "block";
    }
    function initEditDropdown() {
        const select = document.getElementById("editMenuSelect"); select.innerHTML = '<option value="">√úr√ºn Se√ßiniz...</option>';
        currentMenu.sort((a, b) => a.cat.localeCompare(b.cat));
        currentMenu.forEach(item => {
            const option = document.createElement("option"); option.value = JSON.stringify(item);
            option.text = `${item.cat} - ${item.ad} (${item.fiyat} ‚Ç∫)`; select.appendChild(option);
        });
    }
    function renderEditList() {
        const list = document.getElementById("editList"); const totalSpan = document.getElementById("editTotal");
        list.innerHTML = ""; let total = 0;
        editingItems.forEach((item, index) => {
            total += item.fiyat;
            const li = document.createElement("li");
            li.innerHTML = `<span>${item.ad}</span> <div style="display:flex; align-items:center; gap:10px;"><span style="font-weight:bold; color:#e74c3c;">${item.fiyat}‚Ç∫</span><div class="del-item" onclick="editUrunSil(${index})"><i class="fas fa-trash"></i></div></div>`;
            list.appendChild(li);
        });
        totalSpan.textContent = total;
    }
    window.editUrunSil = function(index) { editingItems.splice(index, 1); renderEditList(); }
    window.editUrunEkle = function() {
        const select = document.getElementById("editMenuSelect"); if(select.value === "") return;
        editingItems.push(JSON.parse(select.value)); renderEditList();
    }
    window.editKaydet = function() {
        if(!window.updateOrderInFirebase) return;
        if(confirm("Deƒüi≈üiklikler kaydedilsin mi?")) {
            const newTotal = editingItems.reduce((acc, item) => acc + item.fiyat, 0);
            const currentOrder = activeOrders[editingOrderKey];
            let updatedMusteri = currentOrder.musteri;
            if(currentOrder.isPaket) {
                const yeniIsim = document.getElementById("editPaketIsim").value;
                const yeniAdres = document.getElementById("editPaketAdres").value;
                updatedMusteri = { ...currentOrder.musteri, isim: yeniIsim, adres: yeniAdres };
                if(updatedMusteri.tel) {
                    window.saveCustomerToFirebase(updatedMusteri.tel, yeniIsim, yeniAdres);
                }
            }
            window.updateFullOrderInFirebase(editingOrderKey, editingItems, newTotal, updatedMusteri, () => { document.getElementById("editModal").style.display = "none"; });
        }
    }
    window.editSiparisiIptal = function() {
        if(confirm("Dƒ∞KKAT! Bu sipari≈ü tamamen silinecek.")) {
            window.cancelOrderInFirebase(editingOrderKey, () => { document.getElementById("editModal").style.display = "none"; });
        }
    }

    window.openMenuManager = function() {
        renderMenuManageTable(); document.getElementById("menuManageModal").style.display = "block";
        const tbody = document.getElementById("menuManageBody");
        new Sortable(tbody, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { updateMenuOrderFromDOM(); } });
    }
    function renderMenuManageTable() {
        const tbody = document.getElementById("menuManageBody"); const filter = document.getElementById("filterCategory").value;
        tbody.innerHTML = "";
        currentMenu.forEach((item, index) => {
            if(filter !== 'all' && item.cat !== filter) return;
            const tr = document.createElement("tr"); tr.setAttribute("data-index", index); 
            let categorySelect = `<select class="cat-select" onchange="updateMenuItem(${index}, 'cat', this.value)">`;
            CATEGORIES.forEach(c => { categorySelect += `<option value="${c}" ${c === item.cat ? 'selected' : ''}>${c}</option>`; });
            categorySelect += `</select>`;
            tr.innerHTML = `<td class="drag-handle">‚ò∞</td><td>${categorySelect}</td><td><input type="text" class="menu-input" value="${item.ad}" onchange="updateMenuItem(${index}, 'ad', this.value)"></td><td><input type="number" class="menu-input" value="${item.fiyat}" onchange="updateMenuItem(${index}, 'fiyat', this.value)"></td><td style="text-align:center;"><span class="del-item" onclick="deleteMenuItem(${index})">X</span></td>`;
            tbody.appendChild(tr);
        });
    }
    function updateMenuOrderFromDOM() {
        const rows = document.querySelectorAll('#menuManageBody tr');
        const newOrderIndices = Array.from(rows).map(row => parseInt(row.getAttribute('data-index')));
        const availableSlots = [...newOrderIndices].sort((a, b) => a - b);
        const oldMenu = [...currentMenu];
        availableSlots.forEach((slotIndex, i) => { const oldIndex = newOrderIndices[i]; currentMenu[slotIndex] = oldMenu[oldIndex]; });
        renderMenuManageTable(); 
    }
    window.updateMenuItem = function(index, field, value) { if(field === 'fiyat') value = Number(value); currentMenu[index][field] = value; }
    window.deleteMenuItem = function(index) { if(confirm("Sil?")) { currentMenu.splice(index, 1); renderMenuManageTable(); } }
    window.addNewMenuRow = function() {
        const filter = document.getElementById("filterCategory").value;
        currentMenu.push({ cat: filter !== 'all' ? filter : CATEGORIES[0], ad: "Yeni √úr√ºn", fiyat: 0 }); renderMenuManageTable();
    }
    window.addNewCategory = function() {
        const cat = prompt("Yeni Kategori:");
        if(cat && !CATEGORIES.includes(cat)) { CATEGORIES.push(cat); window.saveCategoriesToFirebase(); renderMenuManageTable(); }
    }
    window.saveMenuChanges = function() {
        if(confirm("Kaydet?")) { window.saveMenuToFirebase(currentMenu, () => { document.getElementById("menuManageModal").style.display = "none"; window.renderMenu(currentMenu); }); }
    }
    
    window.toggleCard = function(key) {
        collapsedStates[key] = !collapsedStates[key];
        const card = document.getElementById('card-' + key);
        const icon = document.getElementById('icon-' + key);
        if(card && icon) {
            if(collapsedStates[key]) {
                card.classList.add('card-collapsed');
                icon.className = "fas fa-eye-slash toggle-icon";
            } else {
                card.classList.remove('card-collapsed');
                icon.className = "fas fa-eye toggle-icon";
            }
        }
    }

    // --- Bƒ∞LDƒ∞Rƒ∞M VE SES MANTIƒûI ---
    window.showReadyOrdersModal = function() {
        const container = document.getElementById("readyOrdersList");
        container.innerHTML = "";
        
        // ≈ûu anki kullanƒ±cƒ± moduna g√∂re filtrele
        let filteredOrders = [];
        
        Object.keys(activeOrders).forEach(key => {
            const siparis = activeOrders[key];
            if(siparis.durum !== 'hazir') return; // Sadece hazƒ±rlarƒ± g√∂ster

            let isRelevant = false;
            
            if (currentUserMode === 'paket' && siparis.isPaket) isRelevant = true;
            else if (currentUserMode === 'alt' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo > 18) isRelevant = true;
            }
            else if (currentUserMode === 'ust' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo <= 18) isRelevant = true;
            }

            if(isRelevant) {
                const urunler = siparis.urunler || [];
                let urunHTML = "";
                urunler.forEach(u => {
                    let porsiyonText = (u.porsiyon && u.porsiyon !== 1) ? ` (${u.porsiyon} Pors.)` : "";
                    urunHTML += `<li>‚úÖ ${u.ad.split(" (")[0]}${porsiyonText}</li>`;
                });
                
                let baslik = siparis.isPaket ? `üõµ ${siparis.kurye || '?'} - ${siparis.musteri.isim}` : `${siparis.masa}`;
                
                container.innerHTML += `
                    <div class="order-card" style="border-left:5px solid #27ae60;">
                        <div class="order-header">${baslik} <span style="font-size:13px; color:#888">${siparis.hazir_saat || ''}</span></div>
                        <ul class="order-list-compact">${urunHTML}</ul>
                    </div>
                `;
            }
        });

        if(container.innerHTML === "") {
            container.innerHTML = "<p style='text-align:center;'>Hazƒ±r sipari≈ü bulunmuyor.</p>";
        }

        document.getElementById("readyOrdersModal").style.display = "block";
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCj9AGZsqvxMCmzrJDFUbj1teFd5st3IeQ",
        authDomain: "mutena-dijital-adisyon-becab.firebaseapp.com",
        databaseURL: "https://mutena-dijital-adisyon-becab-default-rtdb.firebaseio.com",
        projectId: "mutena-dijital-adisyon-becab",
        storageBucket: "mutena-dijital-adisyon-becab.firebasestorage.app",
        messagingSenderId: "68716658785",
        appId: "1:68716658785:web:ced487b01fe98a15b5aa20",
        measurementId: "G-26NWRGRVW4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.currentKasaSifre = "1234";
    const settingsRef = ref(db, 'settings/kasaSifresi');
    onValue(settingsRef, (snapshot) => {
        if (snapshot.exists()) { window.currentKasaSifre = snapshot.val().toString(); } else { set(settingsRef, "1234"); }
    });
    window.saveNewPasswordToFirebase = function(newPass) {
        set(settingsRef, newPass).then(() => { alert("‚úÖ ≈ûifre deƒüi≈ütirildi!"); document.getElementById('passwordChangeModal').style.display = 'none'; });
    }

    window.findCustomerInFirebase = function(tel, callback) {
        get(ref(db, 'musteriler/' + tel)).then((snapshot) => {
            if(snapshot.exists()) { callback(snapshot.val()); } else { callback(null); }
        });
    }
    window.saveCustomerToFirebase = function(tel, isim, adres) {
        set(ref(db, 'musteriler/' + tel), { isim: isim, adres: adres, sonSiparis: new Date().toLocaleDateString() });
    }

    window.fetchMenu = function() {
        const menuRef = ref(db, 'menu');
        get(menuRef).then((snapshot) => {
            if (snapshot.exists()) { window.renderMenu(snapshot.val()); } 
            else { set(menuRef, defaultMenuData); window.renderMenu(defaultMenuData); }
        });
        onValue(menuRef, (snapshot) => { if (snapshot.exists()) { window.renderMenu(snapshot.val()); } });
        get(ref(db, 'categories')).then(snap => { if(snap.exists()) CATEGORIES = snap.val(); else set(ref(db, 'categories'), CATEGORIES); });
    }
    window.saveMenuToFirebase = function(newMenu, callback) { set(ref(db, 'menu'), newMenu).then(() => { alert("G√ºncellendi!"); callback(); }); }
    window.saveCategoriesToFirebase = function() { set(ref(db, 'categories'), CATEGORIES); }

    window.sendOrder = function(orderData, callback) {
        const siparisRef = ref(db, 'siparisler');
        const yeniSiparis = {
            ...orderData, durum: 'hazirlaniyor',
            toplam: orderData.urunler.reduce((a, b) => a + b.fiyat, 0),
            tarih: new Date().toLocaleDateString('tr-TR'),
            saat: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
        };
        push(siparisRef, yeniSiparis).then(() => { alert("‚úÖ ƒ∞letildi!"); callback(); });
    }

    window.updateOrderInFirebase = function(key, newItems, newTotal, status, callback) {
        update(ref(db, 'siparisler/' + key), { urunler: newItems, toplam: newTotal, durum: status }).then(() => { alert("‚úÖ G√ºncellendi!"); callback(); });
    }
    
    window.updateFullOrderInFirebase = function(key, newItems, newTotal, musteriData, callback) {
        update(ref(db, 'siparisler/' + key), { urunler: newItems, toplam: newTotal, musteri: musteriData }).then(() => { alert("‚úÖ Sipari≈ü ve Bilgiler G√ºncellendi!"); callback(); });
    }

    window.cancelOrderInFirebase = function(key, callback) {
        remove(ref(db, 'siparisler/' + key)).then(() => { alert("üóëÔ∏è Silindi."); callback(); });
    }

    // ANA Dƒ∞NLEYƒ∞Cƒ∞ (T√ºm sipari≈üleri tek seferde √ßeker, bildirimleri y√∂netir)
    onValue(ref(db, 'siparisler'), (snapshot) => {
        const data = snapshot.val(); 
        activeOrders = data || {}; 
        
        // Garson Paneli Masalarƒ±nƒ± G√ºncelle
        if(document.getElementById("garson-panel").style.display === "block") {
            const select = document.getElementById("masaSecimi"); 
            if(select) {
                for (let i = 0; i < select.options.length; i++) {
                    const opt = select.options[i]; if (opt.value === "") continue;
                    const isActive = Object.values(activeOrders).some(o => o.masa === opt.value);
                    if(isActive) { opt.classList.add('busy-table'); if(!opt.text.includes("(DOLU)")) opt.text = opt.value + " (DOLU)"; } 
                    else { opt.classList.remove('busy-table'); opt.text = opt.value; }
                }
                if(select.value) masaKontrol();
            }
        }

        // Kasa Paneli G√ºncelle
        if(document.getElementById("kasa-panel").style.display === "block") {
            window.siparisleriGetir();
        }

        // Mutfak Paneli G√ºncelle
        if(document.getElementById("mutfak-panel").style.display === "block") {
            window.mutfakSiparisleriDinle();
        }

        // Bƒ∞LDƒ∞Rƒ∞M KONTROL√ú
        window.checkReadyNotifications();
    });

    window.checkReadyNotifications = function() {
        if (!currentUserMode) return; // Eƒüer ana ekrandaysa bildirim yok

        let readyCount = 0;
        Object.values(activeOrders).forEach(siparis => {
            if (siparis.durum !== 'hazir') return;

            // Filtreleme
            if (currentUserMode === 'paket' && siparis.isPaket) readyCount++;
            else if (currentUserMode === 'alt' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo > 18) readyCount++;
            }
            else if (currentUserMode === 'ust' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo <= 18) readyCount++;
            }
        });

        const badge = document.getElementById("notificationBadge");
        
        if (readyCount > 0) {
            badge.style.display = "block";
            badge.innerText = readyCount;
            // Eƒüer sayƒ± arttƒ±ysa ses √ßal
            if (readyCount > previousReadyCount) {
                playNotificationSound();
            }
        } else {
            badge.style.display = "none";
        }
        previousReadyCount = readyCount;
    }

    // Fonksiyon tanƒ±mlarƒ±nƒ± korumak i√ßin bo≈ü fonksiyonlar (onValue i√ßinde √ßaƒürƒ±lƒ±yor artƒ±k)
    window.garsonMasalariDinle = function() {} 

    window.mutfakSiparisleriDinle = function() {
        // Bu fonksiyon artƒ±k sadece DOM manip√ºlasyonu yapƒ±yor, veri onValue'dan global geliyor
        const data = activeOrders;
        const listAlt = document.getElementById("list-alt");
        const listUst = document.getElementById("list-ust");
        const listPaket = document.getElementById("list-paket");
        
        if(listAlt) { // Eƒüer mutfak paneli a√ßƒ±ksa
            listAlt.innerHTML = ""; listUst.innerHTML = ""; listPaket.innerHTML = "";
            if (!data) return; 

            Object.keys(data).forEach(key => {
                const siparis = data[key];
                const yemekler = siparis.urunler ? siparis.urunler.filter(u => u.cat !== 'ƒ∞√áECEKLER') : [];
                if (yemekler.length === 0) return; 

                const isOrderDone = siparis.durum === 'hazir';
                const isCollapsed = collapsedStates[key] || false;
                
                let cardClass = isOrderDone ? "order-card kitchen-card order-done" : "order-card kitchen-card";
                if(isCollapsed) cardClass += " card-collapsed";
                let iconClass = isCollapsed ? "fas fa-eye-slash toggle-icon" : "fas fa-eye toggle-icon";

                let urunHTML = "";
                yemekler.forEach(u => {
                    let porsiyonText = (u.porsiyon && u.porsiyon !== 1) ? ` <span style='color:#e74c3c; font-weight:bold;'>(${u.porsiyon} Pors.)</span>` : "";
                    if(isOrderDone || u.hazir) {
                        urunHTML += `<li class="kitchen-item-ready" style="color:#2d3436; text-decoration:line-through; font-weight:bold;">‚úÖ ${u.ad.split(" (")[0]}${porsiyonText}</li>`;
                    } else {
                        urunHTML += `<li class="kitchen-item-new">üî• ${u.ad.split(" (")[0]}${porsiyonText}</li>`;
                    }
                });

                let notHTML = siparis.not ? `<div style='background:#fff3cd; padding:5px; margin-top:5px; border-radius:5px; font-weight:bold;'>üìù ${siparis.not}</div>` : "";
                let paketBilgi = "";
                let baslik = "";
                
                if(siparis.isPaket) {
                    baslik = `<span style="font-size:15px;">${siparis.kurye || '?'} - ${siparis.musteri.isim}</span>`;
                    paketBilgi = `<div class="order-details-wrapper" style="font-size:12px; color:#666; margin-top:5px; border-top:1px dashed #ccc;">üìç ${siparis.musteri.adres}</div>`;
                } else {
                    baslik = `<span style="font-size:20px;">${siparis.masa}</span>`;
                }

                let butonHTML = "";
                if(isOrderDone) {
                    butonHTML = `<div class="order-details-wrapper" style="margin-top:10px; background:#27ae60; color:white; text-align:center; padding:10px; border-radius:8px; font-weight:bold;">‚úÖ SERVƒ∞SE HAZIR<br><span style="font-size:11px;">${siparis.hazir_saat}</span></div>`;
                } else {
                    butonHTML = `<button class="ready-btn" onclick="siparisiHazirla('${key}')">üë®‚Äçüç≥ HAZIRLA</button>`;
                }

                const cardHTML = `
                    <div id="card-${key}" class="${cardClass}">
                        <div class="order-header" style="margin-bottom:5px;">
                            ${baslik} 
                            <i id="icon-${key}" class="${iconClass}" onclick="toggleCard('${key}')"></i>
                            <span class="order-details-wrapper" style="font-size:14px; color:#666; float:right; margin-right:10px;">${siparis.saat}</span>
                        </div>
                        <ul class="order-list-compact" style="margin-bottom:10px;">${urunHTML}</ul>
                        <div class="order-details-wrapper">${notHTML}</div>
                        ${paketBilgi}
                        ${butonHTML}
                    </div>
                `;

                if (siparis.isPaket) { listPaket.innerHTML += cardHTML; } 
                else {
                    let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                    if (masaNo >= 1 && masaNo <= 18) { listUst.innerHTML += cardHTML; } 
                    else { listAlt.innerHTML += cardHTML; }
                }
            });
        }
    }

    window.siparisiHazirla = async function(key) {
        const snap = await get(ref(db, 'siparisler/' + key));
        if (snap.exists()) {
            const order = snap.val();
            const updated = order.urunler.map(u => { if(u.cat !== 'ƒ∞√áECEKLER') return { ...u, hazir: true }; return u; });
            update(ref(db, 'siparisler/' + key), { urunler: updated, durum: 'hazir', hazir_saat: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'}) });
        }
    }

    window.siparisleriGetir = function() {
        // DOM Manipulasyonu
        const data = activeOrders;
        const container = document.getElementById("kasaContainer");
        if(container) {
            container.innerHTML = ""; 
            if (!data) { container.innerHTML = "<p style='text-align:center;'>Sipari≈ü yok.</p>"; return; }

            const altDiv = document.createElement("div"); altDiv.className = "floor-section";
            altDiv.innerHTML = '<div class="floor-title bg-alt">‚¨áÔ∏è ALT KAT</div><div class="order-container" id="grid-alt"></div>';
            
            const ustDiv = document.createElement("div"); ustDiv.className = "floor-section";
            ustDiv.innerHTML = '<div class="floor-title bg-ust">‚¨ÜÔ∏è √úST KAT</div><div class="order-container" id="grid-ust"></div>';

            const paketDiv = document.createElement("div"); paketDiv.className = "floor-section";
            paketDiv.innerHTML = '<div class="floor-title bg-paket">üõµ PAKET SERVƒ∞S</div><div class="order-container" id="grid-paket"></div>';

            container.appendChild(altDiv); container.appendChild(ustDiv); container.appendChild(paketDiv);
            
            Object.keys(data).forEach(key => {
                const siparis = data[key];
                let targetGrid, cardClass;
                if (siparis.isPaket) { targetGrid = document.getElementById("grid-paket"); cardClass = "card-paket"; } 
                else {
                    let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                    if (masaNo >= 1 && masaNo <= 18) { targetGrid = document.getElementById("grid-ust"); cardClass = "card-ust"; }
                    else { targetGrid = document.getElementById("grid-alt"); cardClass = "card-alt"; }
                }
                let urunHTML = "";
                siparis.urunler.forEach(u => { urunHTML += `<li><span>${u.ad.split(" (")[0]}</span> <span>${u.fiyat}‚Ç∫</span></li>`; });
                let header = siparis.isPaket ? `<span>üõµ ${siparis.kurye} - ${siparis.musteri.isim}</span>` : `<span>${siparis.masa}</span>`;
                let adresBilgi = siparis.isPaket ? `<div style='font-size:11px; color:#555; margin-bottom:5px;'>${siparis.musteri.adres}</div>` : "";
                
                const div = document.createElement("div"); div.className = `order-card ${cardClass}`;
                div.innerHTML = `<div class="order-header">${header} <span style="font-size:13px; color:#888">${siparis.saat}</span></div>${adresBilgi}<div class="order-list-container"><ul class="order-list-compact">${urunHTML}</ul></div><div class="total-price-compact">TOPLAM: ${siparis.toplam} ‚Ç∫</div><div class="action-buttons"><button class="edit-btn" onclick="siparisDuzenle('${key}')">D√úZENLE</button><button class="pay-btn" onclick="hesabiKapat('${key}')">√ñDENDƒ∞</button></div>`;
                if(targetGrid) targetGrid.appendChild(div);
            });
        }
    }

    window.hesabiKapat = async function(key) {
        if(confirm("Hesap √∂dendi mi?")) {
            const snap = await get(ref(db, 'siparisler/' + key));
            if(snap.exists()) { await push(ref(db, 'arsiv'), snap.val()); await remove(ref(db, 'siparisler/' + key)); }
        }
    }

    window.raporlariAc = function() {
        document.getElementById("kasa-panel").style.display = "none"; document.getElementById("rapor-panel").style.display = "block";
        get(ref(db, 'arsiv')).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                let ciro = 0; let sayim = {}; let masaSayisi = 0; let kuryeCiro = {}; 
                Object.values(data).forEach(s => {
                    ciro += s.toplam; masaSayisi++;
                    if(s.urunler) s.urunler.forEach(u => { let temizAd = u.ad.split(" (")[0]; sayim[temizAd] = (sayim[temizAd] || 0) + (u.porsiyon || 1); });
                    if(s.isPaket && s.kurye) { kuryeCiro[s.kurye] = (kuryeCiro[s.kurye] || 0) + s.toplam; }
                });
                document.getElementById("gunlukCiro").innerText = ciro + " ‚Ç∫"; document.getElementById("toplamMasa").innerText = masaSayisi;
                const liste = document.getElementById("satilanUrunlerListesi"); liste.innerHTML = "";
                Object.entries(sayim).sort((a,b)=>b[1]-a[1]).forEach(([ad, adet]) => { liste.innerHTML += `<li style='border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; font-size:14px;'><span>${ad}</span> <b>${adet} Pors.</b></li>`; });
                const kuryeListesi = document.getElementById("kuryeRaporListesi"); kuryeListesi.innerHTML = "";
                if(Object.keys(kuryeCiro).length === 0) { kuryeListesi.innerHTML = "<span style='color:#999'>Hen√ºz paket teslimatƒ± yok.</span>"; } 
                else { Object.entries(kuryeCiro).forEach(([isim, tutar]) => { kuryeListesi.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #f0f0f0;"><span style="font-weight:bold;"><i class="fas fa-user-helmet-safety"></i> ${isim}</span><span style="color:#27ae60; font-weight:800;">${tutar} ‚Ç∫</span></div>`; }); }
            }
        });
    }

    window.raporlariSifirla = function() {
        if(confirm("G√ºn√º kapatƒ±p ciroyu sƒ±fƒ±rlƒ±yor musun?")) { remove(ref(db, 'arsiv')).then(() => { alert("Sƒ±fƒ±rlandƒ±!"); window.raporlariAc(); }); }
    }
</script>
</body>
</html>
