<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mutena Dijital Adisyon</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
      if (localStorage.getItem("mutenaGiris") !== "true") {
        var password = prompt("L√ºtfen giri≈ü ≈üifresini yazƒ±n:");
        if (password === "mutena123") {
          localStorage.setItem("mutenaGiris", "true");
        } else {
          alert("Hatalƒ± ≈üifre!");
          window.location.href = "https://google.com";
        }
      }
    </script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --glass: rgba(255, 255, 255, 0.95);
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--background); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-top: 80px; 
            padding-bottom: 40px;
        }

        /* --- YAZDIRMA ALANI --- */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                display: block !important;
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: 'Courier New', Courier, monospace;
                color: black; background: white; z-index: 9999;
                padding: 0; margin: 0;
            }
            .print-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
            .print-title { font-size: 18px; font-weight: bold; margin: 0; }
            .print-info { font-size: 12px; margin-top: 5px; }
            .print-delivery { font-size: 12px; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; font-weight: bold; }
            .print-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 10px; }
            .print-table td { padding: 5px 0; border-bottom: 1px dashed #ccc; }
            .print-total { text-align: right; font-size: 16px; font-weight: bold; border-top: 2px dashed #000; padding-top: 10px; }
            .print-footer { text-align: center; font-size: 10px; margin-top: 20px; }
            @page { margin: 0; size: auto; }
        }

        header { 
            background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 15px 20px; 
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; 
            display: flex; align-items: center; justify-content: center;
            box-sizing: border-box; box-shadow: var(--shadow-sm);
        }
        
        h1 { margin: 0; font-weight: 800; font-size: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        
        .notification-bell { position: absolute; right: 20px; font-size: 24px; color: var(--text-main); cursor: pointer; display: none; transition: transform 0.2s; }
        .notification-bell:active { transform: scale(0.9); }
        .notification-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid white; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .mode-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; padding: 20px; max-width: 800px; margin: 0 auto; margin-top: 20px; }
        .dashboard-card { background: var(--surface); border-radius: var(--radius-lg); padding: 30px 20px; text-align: center; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .dashboard-card:active { transform: scale(0.98); }
        .dashboard-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; margin-bottom: 5px; box-shadow: var(--shadow-sm); }
        .dash-garson-alt .dashboard-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .dash-garson-ust .dashboard-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .dash-paket .dashboard-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .dash-mutfak .dashboard-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .dash-kasa .dashboard-icon { background: linear-gradient(135deg, #10b981, #059669); }
        .dash-title { font-weight: 700; font-size: 16px; color: var(--text-main); }
        .dash-desc { font-size: 12px; color: var(--text-muted); font-weight: 500; }

        #garson-panel, #kasa-panel, #mutfak-panel, #rapor-panel, #paket-panel { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 140px; }

        .garson-header { position: sticky; top: 75px; z-index: 800; background: var(--background); padding: 10px 0; margin-bottom: 10px; }
        .garson-controls { display: flex; gap: 10px; }
        .table-select, .search-input, .customer-input, .note-area { width: 100%; padding: 14px; font-size: 15px; border: 1px solid #e2e8f0; border-radius: var(--radius-md); font-weight: 500; background: var(--surface); color: var(--text-main); box-shadow: var(--shadow-sm); outline: none; appearance: none; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; font-family: inherit; }
        .table-select:focus, .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        option.busy-table { background-color: #fffbeb; color: #b45309; font-weight: bold; }

        .category-wrapper { margin-bottom: 15px; }
        .category-title { background: var(--surface); color: var(--text-main); padding: 16px 20px; border-radius: var(--radius-md); font-weight: 700; font-size: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); border-left: 4px solid var(--primary); transition: background 0.2s; }
        .category-title:active { background: #f8fafc; }
        .category-items { display: none; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; padding: 15px 5px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .menu-item { background: var(--surface); padding: 15px; border-radius: var(--radius-md); text-align: center; border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .menu-item:active { transform: scale(0.96); border-color: var(--primary); }
        .menu-name { font-weight: 600; font-size: 14px; color: var(--text-main); margin-bottom: 8px; line-height: 1.4; }
        .menu-price { color: var(--primary); font-weight: 800; font-size: 16px; background: #eef2ff; padding: 4px 10px; border-radius: var(--radius-full); align-self: center; }

        .cart-section { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: var(--text-main); color: white; padding: 12px 20px; border-radius: var(--radius-full); box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 999; display: flex; justify-content: space-between; align-items: center; cursor: pointer; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
        .cart-total-info { font-size: 15px; font-weight: 500; display: flex; flex-direction: column; line-height: 1.2;}
        .cart-total-info span { color: var(--accent); font-weight: 800; font-size: 18px; }
        .cart-btn-text { font-weight: 700; font-size: 14px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: var(--radius-full); }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--surface); width: 92%; max-width: 450px; margin: 0 auto; margin-top: 80px; padding: 25px; border-radius: 24px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: var(--shadow-lg); animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .order-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        /* MUTFAK ƒ∞√áƒ∞N √ñZEL SIKI GRID YAPISI */
        .kitchen-order-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }

        .order-card { background: var(--surface); border-radius: var(--radius-md); padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; display: flex; flex-direction: column; transition: transform 0.2s; position: relative; overflow: hidden; }
        .order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: #cbd5e1; }
        .card-alt::before { background: var(--accent); }
        .card-ust::before { background: #8b5cf6; }
        .card-paket::before { background: #3b82f6; }
        .order-header { font-weight: 800; font-size: 17px; color: var(--text-main); display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #e2e8f0;}
        .order-list-compact { list-style: none; padding: 0; margin: 0; font-size: 14px; color: var(--text-main); }
        .order-list-compact li { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .action-buttons { display: flex; gap: 8px; margin-top: 15px; }
        .action-btn-sm { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; font-size: 13px; font-family: inherit;}
        .btn-print { background: #64748b; color: white; }

        /* Mutfak B√∂l√ºm Ba≈ülƒ±klarƒ± (Kasa stili) */
        .floor-section { margin-bottom: 30px; }
        .floor-title { font-size: 16px; font-weight: 800; padding: 12px 20px; border-radius: var(--radius-md); margin-bottom: 15px; display: inline-block; box-shadow: var(--shadow-sm); }
        
        /* --- KART K√ú√á√úLTME (Gƒ∞ZLEME) STƒ∞LLERƒ∞ --- */
        .card-collapsed .order-list-compact, 
        .card-collapsed .ready-btn, 
        .card-collapsed .order-details-wrapper,
        .card-collapsed .action-buttons,
        .card-collapsed .total-price-compact,
        .card-collapsed .kitchen-ready-msg { 
            display: none !important; 
        }
        .card-collapsed { padding-bottom: 10px !important; }

        .btn-success { background: var(--success); color: white; }
        .btn-cancel { background: var(--danger); color: white; }
        .btn-edit { background: var(--accent); color: white; }
        .btn-pay { background: var(--primary); color: white; }
        .btn-close { background: #f1f5f9; color: var(--text-muted); }
        .action-btn-full { width: 100%; padding: 15px; border: none; border-radius: var(--radius-md); font-weight: 700; font-size: 16px; cursor: pointer; margin-bottom: 10px; font-family: inherit; transition: opacity 0.2s;}
        .action-btn-full:active { opacity: 0.8; }

        .edit-add-area { background: #f8fafc; padding: 15px; border-radius: var(--radius-md); border: 1px solid #e2e8f0; margin-top: 15px; }
        .edit-row { display: flex; gap: 8px; margin-top: 8px; align-items: stretch; }
        .btn-add-product { background-color: var(--success) !important; color: white !important; border: none; border-radius: var(--radius-md); font-weight: 800; cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; }

        .back-btn { background: transparent; color: var(--text-muted); border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: var(--radius-full); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;}
        .back-btn:hover { background: #f1f5f9; color: var(--text-main); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

<header>
    <h1>MUTENA ADƒ∞SYON</h1>
    <div id="notificationBell" class="notification-bell" onclick="showReadyOrdersModal()">
        <i class="fas fa-bell"></i>
        <div id="notificationBadge" class="notification-badge" style="display:none;">0</div>
    </div>
</header>

<div id="print-area"></div>

<div class="mode-selector" id="giris-ekrani">
    <div class="dashboard-card dash-garson-alt" onclick="openMode('garson-alt')">
        <div class="dashboard-icon"><i class="fas fa-utensils"></i></div>
        <div><div class="dash-title">ALT KAT GARSON</div><div class="dash-desc">Masa 61-68</div></div>
    </div>
    <div class="dashboard-card dash-garson-ust" onclick="openMode('garson-ust')">
        <div class="dashboard-icon"><i class="fas fa-layer-group"></i></div>
        <div><div class="dash-title">√úST KAT GARSON</div><div class="dash-desc">Masa 1-18</div></div>
    </div>
    <div class="dashboard-card dash-paket" onclick="openMode('paket')">
        <div class="dashboard-icon"><i class="fas fa-motorcycle"></i></div>
        <div><div class="dash-title">PAKET SERVƒ∞S</div><div class="dash-desc">Telefon & Adres</div></div>
    </div>
    <div class="dashboard-card dash-mutfak" onclick="openMode('mutfak')">
        <div class="dashboard-icon"><i class="fas fa-fire-alt"></i></div>
        <div><div class="dash-title">MUTFAK</div><div class="dash-desc">Sipari≈ü Takibi</div></div>
    </div>
    <div class="dashboard-card dash-kasa" onclick="openMode('kasa')">
        <div class="dashboard-icon"><i class="fas fa-cash-register"></i></div>
        <div><div class="dash-title">KASA & Y√ñNETƒ∞M</div><div class="dash-desc">√ñdeme & Rapor</div></div>
    </div>
</div>

<div id="passwordModal" class="modal" style="z-index: 2000;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-lock" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Y√∂netici Giri≈üi</h3>
        <input type="password" id="kasaSifreInput" placeholder="****" inputmode="numeric" class="search-input" style="text-align:center; letter-spacing: 5px; font-size: 24px;">
        <br><br>
        <button class="action-btn-full btn-success" onclick="sifreKontrolEt()">Gƒ∞Rƒ∞≈û YAP</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="passwordChangeModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-key" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Kasa ≈ûifresini Deƒüi≈ütir</h3>
        <input type="password" id="eskiSifreInput" placeholder="Mevcut ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        <input type="text" id="yeniSifreInput" placeholder="Yeni ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        <button class="action-btn-full btn-success" onclick="sifreyiVeritabanindaGuncelle()">KAYDET VE DEƒûƒ∞≈ûTƒ∞R</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordChangeModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="garson-panel">
    <div class="garson-header">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="back-btn" onclick="location.reload()"><i class="fas fa-chevron-left"></i> Men√º</button>
            <span style="font-weight:700; color:var(--primary);">Sipari≈ü Ekranƒ±</span>
        </div>
        <div class="garson-controls">
            <select id="masaSecimi" class="table-select" onchange="masaKontrol()"></select>
            <input type="text" id="urunArama" class="search-input" placeholder="üîç Men√ºde Ara..." onkeyup="urunAra()">
        </div>
        <div id="masaDurumBilgisi"></div>
    </div>
    <div id="menuContainer"></div>
    <div id="miniCart" class="mini-cart-container"></div>
    <div class="cart-section" onclick="sepetiAc()">
        <div class="cart-total-info">
            <span>Toplam</span>
            <div id="sepetToplam" style="font-size: 20px; font-weight:800; color:var(--accent);">0 ‚Ç∫</div>
        </div>
        <div class="cart-btn-text">SEPETƒ∞ ONAYLA <i class="fas fa-arrow-right"></i></div>
    </div>
</div>

<div id="paket-panel">
    <div style="position:sticky; top:75px; z-index:800; background:var(--background); padding-bottom:10px;">
        <button class="back-btn" onclick="location.reload()" style="margin-bottom:10px;"><i class="fas fa-chevron-left"></i> Men√º</button>
        <div class="customer-form">
            <h4 style="margin:0 0 10px 0; color:var(--primary);"><i class="fas fa-user"></i> M√º≈üteri Bilgileri</h4>
            <div style="display:flex; gap:10px;">
                <input type="tel" id="paketTel" class="customer-input" placeholder="Telefon (5XXXXXXXXX)" onblur="musteriAra()">
                <button onclick="musteriAra()" style="height:48px; background:var(--primary); color:white; border:none; border-radius:8px; width:60px;"><i class="fas fa-search"></i></button>
            </div>
            <input type="text" id="paketIsim" class="customer-input" placeholder="M√º≈üteri Adƒ±">
            <textarea id="paketAdres" class="customer-input" rows="2" placeholder="Adres"></textarea>
        </div>
        <input type="text" id="paketUrunArama" class="search-input" placeholder="üîç Men√ºde Ara..." onkeyup="urunAraPaket()">
    </div>
    <div id="paketMenuContainer" style="padding-top:10px;"></div>
    <div id="paketMiniCart" class="mini-cart-container"></div>
    <div class="cart-section" onclick="sepetiAcPaket()" style="background:#1e293b;">
        <div class="cart-total-info">
            <span>Paket Toplam</span>
            <div id="paketSepetToplam" style="font-size: 20px; font-weight:800; color:var(--accent);">0 ‚Ç∫</div>
        </div>
        <div class="cart-btn-text">Sƒ∞PARƒ∞≈ûƒ∞ TAMAMLA <i class="fas fa-check"></i></div>
    </div>
</div>

<div id="sepetModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--primary); border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;">
            <i class="fas fa-shopping-basket"></i> Sipari≈ü √ñzeti
        </h3>
        <ul id="sepetListesi" class="modal-list"></ul>
        <div id="kuryeSecimDiv" style="display:none; margin-bottom:15px; background:#f0f9ff; padding:15px; border-radius:12px; border:1px solid #bae6fd;">
            <label style="font-weight:bold; display:block; margin-bottom:8px; color:#0369a1;">üõµ Kurye Se√ß:</label>
            <select id="kuryeSecimi" class="table-select" style="width:100%;">
                <option value="Uƒüur">Uƒüur</option>
                <option value="Yƒ±lmaz">Yƒ±lmaz</option>
                <option value="Diger">Diƒüer</option>
            </select>
        </div>
        <textarea id="siparisNotu" class="note-area" rows="2" placeholder="Not ekle (√ñrn: Acƒ±sƒ±z, Soƒüansƒ±z)..."></textarea>
        <button class="action-btn-full btn-success" onclick="firebasedenGonder()">‚úÖ Sƒ∞PARƒ∞≈ûƒ∞ G√ñNDER</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('sepetModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="mutfak-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-chevron-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="font-weight:800; color:var(--danger); font-size:20px; letter-spacing:1px;">
            <i class="fas fa-fire-alt"></i> MUTFAK
        </div>
    </div>
    <div id="mutfakContainer"></div>
</div>

<div id="readyOrdersModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--success); border-bottom:1px solid #e2e8f0; padding-bottom:15px;">
            <i class="fas fa-bell"></i> Hazƒ±r Sipari≈üler
        </h3>
        <div id="readyOrdersList" class="order-container" style="display:flex; flex-direction:column; gap:10px;"></div>
        <br>
        <button class="action-btn-full btn-close" onclick="document.getElementById('readyOrdersModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--text-main);">Sipari≈üi D√ºzenle</h3>
        <h4 id="editMasaBaslik" style="color:var(--primary); margin-top:-10px; margin-bottom:20px; font-weight:600;"></h4>
        
        <div id="editPaketBilgi" style="display:none; margin-bottom:15px; border-bottom:1px dashed #e2e8f0; padding-bottom:15px;">
             <label style="font-weight:bold; color:var(--secondary); font-size:13px; display:block; margin-bottom:5px;">M√º≈üteri Bilgileri:</label>
             <input type="text" id="editPaketIsim" class="customer-input" style="margin-bottom:8px;">
             <textarea id="editPaketAdres" class="customer-input" rows="2"></textarea>
        </div>

        <ul id="editList" class="modal-list" style="max-height:200px; overflow-y:auto;"></ul>
        
        <div class="edit-add-area">
            <label style="font-size: 13px; font-weight: 700; color: var(--text-muted); display:block; margin-bottom:5px;">Listeye Yeni √úr√ºn Ekle:</label>
            <div class="edit-row">
                <select id="editMenuSelect" class="table-select" style="flex: 2; border-color:#cbd5e1;"></select>
                <select id="editYeniUrunPorsiyon" class="table-select" style="flex: 1; border-color:#cbd5e1;">
                    <option value="1">1 Pors.</option>
                    <option value="1.5">1.5 Pors.</option>
                    <option value="2">2 Pors.</option>
                </select>
            </div>
            <div style="margin-top:8px;">
                <button onclick="editUrunEkle()" class="btn-add-product" style="width:100%; padding:12px;">
                    <i class="fas fa-plus-circle" style="margin-right:8px;"></i> EKLE
                </button>
            </div>
        </div>

        <div style="text-align:right; font-weight:800; margin:20px 0; font-size:18px; color:var(--text-main);">
            Yeni Toplam: <span id="editTotal" style="color:var(--success);">0</span> ‚Ç∫
        </div>
        <button class="action-btn-full btn-success" onclick="editKaydet()">DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
        <div style="display:flex; gap:10px;">
            <button class="action-btn-full btn-cancel" onclick="editSiparisiIptal()" style="margin-top:0;">ƒ∞PTAL ET</button>
            <button class="action-btn-full btn-close" onclick="document.getElementById('editModal').style.display='none'" style="margin-top:0;">Kapat</button>
        </div>
    </div>
</div>

<div id="customerListModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--text-main);">Kayƒ±tlƒ± M√º≈üteriler</h3>
            <button onclick="openAddCustomerModal()" class="action-btn-sm" style="background:var(--success); width:auto; padding:8px 12px; font-size:13px;">
                <i class="fas fa-user-plus"></i> Yeni Ekle
            </button>
        </div>

        <input type="text" id="customerSearchInput" class="search-input" placeholder="üîç ƒ∞sim, Tel veya Adres Ara..." onkeyup="filterCustomers()" style="margin-bottom:10px;">
        
        <ul id="customerList" class="modal-list" style="max-height:50vh; overflow-y:auto; padding:0; list-style:none;"></ul>
        
        <button class="action-btn-full" style="background:#e2e8f0; color:#333; margin-top:10px;" onclick="document.getElementById('customerListModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="menuManageModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
        <h3>Men√º Y√∂netimi</h3>
        <select id="filterCategory" class="table-select" style="padding:10px; margin-bottom:15px;" onchange="renderMenuManageTable()">
            <option value="all">üîç T√úM KATEGORƒ∞LER</option>
        </select>
        <div style="max-height:50vh; overflow-y:auto; border-radius:var(--radius-sm); border:1px solid #e2e8f0;">
            <table class="menu-manage-table">
                <thead><tr><th style="width:40px;">‚ò∞</th><th>Kategori</th><th>√úr√ºn</th><th>Fiyat</th><th>Sil</th></tr></thead>
                <tbody id="menuManageBody"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="addNewMenuRow()" class="action-btn-full" style="background:var(--primary); color:white;">+ YENƒ∞ √úR√úN</button>
            <button onclick="addNewCategory()" class="action-btn-full" style="background:var(--secondary); color:white;">+ KAT. EKLE</button>
            <button onclick="deleteCategory()" class="action-btn-full" style="background:var(--danger); color:white;">üóëÔ∏è KAT. Sƒ∞L</button>
        </div>
        <button class="action-btn-full btn-success" style="margin-top:10px;" onclick="saveMenuChanges()">KAYDET VE √áIK</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('menuManageModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="kasa-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:white; padding:15px; border-radius:var(--radius-md); box-shadow:var(--shadow-sm);">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-chevron-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="display:flex; gap:10px;">
<button onclick="openCustomerList()" style="background:#10b981; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer;">
    <i class="fas fa-users"></i> M√º≈üteriler
</button>
             <button onclick="openPasswordChangeModal()" style="background:#f59e0b; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-key"></i> ≈ûifre</button>
            <button onclick="openMenuManager()" style="background:#3b82f6; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-edit"></i> Men√º</button>
            <button onclick="raporlariAc()" style="background:#8b5cf6; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer;"><i class="fas fa-chart-pie"></i> Rapor</button>
        </div>
    </div>
    <div id="kasaContainer"></div>
</div>

<div id="rapor-panel">
    <button class="back-btn" onclick="openMode('kasa-authorized')" style="margin-bottom:20px;">‚Üê Geri</button>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
        <div class="report-card" style="background:white; padding:20px; border-radius:var(--radius-md); box-shadow:var(--shadow-sm); text-align:center;">
            <div style="color:var(--text-muted); font-size:13px; font-weight:600; text-transform:uppercase;">BUG√úNK√ú Cƒ∞RO</div>
            <div class="report-value" id="gunlukCiro" style="font-size:28px; font-weight:800; color:var(--success); margin-top:5px;">0 ‚Ç∫</div>
        </div>

        <div class="report-card" style="background:white; padding:20px; border-radius:var(--radius-md); box-shadow:var(--shadow-sm); text-align:center;">
            <div style="color:var(--text-muted); font-size:13px; font-weight:600; text-transform:uppercase;">ƒ∞≈ûLEM SAYISI</div>
            <div class="report-value" id="toplamMasa" style="font-size:28px; font-weight:800; color:var(--primary); margin-top:5px;">0</div>
        </div>
    </div>
    <div class="report-card" style="text-align:left; background:white; padding:20px; border-radius:var(--radius-md); box-shadow:var(--shadow-sm); margin-bottom:20px;">
        <h4 style="margin-top:0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; color:var(--text-main);"><i class="fas fa-motorcycle"></i> Kurye Tahsilat Durumu</h4>
        <div id="kuryeRaporListesi"></div>
    </div>
    <div class="report-card" style="text-align:left; background:white; padding:20px; border-radius:var(--radius-md); box-shadow:var(--shadow-sm);">
        <h4 style="margin-top:0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; color:var(--text-main);">Satƒ±lan √úr√ºnler</h4>
        <ul id="satilanUrunlerListesi" style="padding-left:0; margin:0; font-size:14px; list-style:none;"></ul>
    </div>
    <br>
    <button class="action-btn-full btn-cancel" onclick="raporlariSifirla()"><i class="fas fa-trash-alt"></i> G√úN SONU AL (SIFIRLA)</button>
</div>

<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playNotificationSound() {
        if(audioContext.state === 'suspended') audioContext.resume();
        const osc = audioContext.createOscillator(); const gain = audioContext.createGain();
        osc.connect(gain); gain.connect(audioContext.destination);
        osc.type = "sine"; osc.frequency.value = 523.25; gain.gain.value = 0.1;
        osc.start(); setTimeout(() => { osc.stop(); }, 200);
        setTimeout(() => { 
            const osc2 = audioContext.createOscillator(); const gain2 = audioContext.createGain();
            osc2.connect(gain2); gain2.connect(audioContext.destination);
            osc2.type = "sine"; osc2.frequency.value = 659.25; gain2.gain.value = 0.1;
            osc2.start(); setTimeout(() => { osc2.stop(); }, 400);
        }, 250);
    }

    const TABLES_ALT = ["Masa 61", "Masa 62", "Masa 63", "Masa 64", "Masa 65", "Masa 66", "Masa 67", "Masa 68"];
    const TABLES_UST = Array.from({length: 18}, (_, i) => `Masa ${i + 1}`); 
    let CATEGORIES = ["G√úN√úN YEMEKLERƒ∞", "√áORBALAR", "IZGARALAR", "Pƒ∞DELER", "KEBAPLAR", "ƒ∞√áECEKLER", "TATLI"];
    
    let currentMenu = []; let sepet = []; let activeOrders = {}; let editingOrderKey = null; let editingItems = [];
    let isPaketMode = false; let collapsedStates = {}; let currentUserMode = ""; let previousReadyCount = 0;

    function openMode(mode) {
        if (mode === 'kasa') {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('kasaSifreInput').value = '';
            document.getElementById('kasaSifreInput').focus();
            return;
        }
        ['giris-ekrani','garson-panel','kasa-panel','mutfak-panel','rapor-panel','paket-panel'].forEach(id => {
            document.getElementById(id).style.display = "none";
        });
        const bell = document.getElementById("notificationBell");
        if(mode === 'garson-alt' || mode === 'garson-ust' || mode === 'paket') { bell.style.display = "block"; } else { bell.style.display = "none"; }

        isPaketMode = false; currentUserMode = ""; 

        if (mode === 'garson-alt') {
            document.getElementById("garson-panel").style.display = "block"; currentUserMode = 'alt';
            updateTableSelect(TABLES_ALT); window.fetchMenu(); 
        } 
        else if (mode === 'garson-ust') {
            document.getElementById("garson-panel").style.display = "block"; currentUserMode = 'ust';
            updateTableSelect(TABLES_UST); window.fetchMenu();
        }
        else if (mode === 'paket') {
            document.getElementById("paket-panel").style.display = "block"; currentUserMode = 'paket';
            isPaketMode = true; window.fetchMenu(); setTimeout(() => window.renderMenu(currentMenu), 500);
        }
        else if (mode === 'mutfak') {
            document.getElementById("mutfak-panel").style.display = "block"; window.mutfakSiparisleriGuncelle();
        }
        else if (mode === 'kasa-authorized') { 
            document.getElementById("kasa-panel").style.display = "block"; window.siparisleriGetir(); window.fetchMenu();
        }
        if(window.checkReadyNotifications) window.checkReadyNotifications();
    }

    function updateTableSelect(tables) {
        const select = document.getElementById("masaSecimi"); select.innerHTML = '<option value="">MASA SE√áƒ∞Nƒ∞Z...</option>';
        tables.forEach(t => { const opt = document.createElement("option"); opt.value = t; opt.text = t; select.appendChild(opt); });
        if(window.checkTableStatus) window.checkTableStatus();
    }

    window.sifreKontrolEt = function() {
        const input = document.getElementById("kasaSifreInput").value; const gecerliSifre = window.currentKasaSifre || "1234";
        if(input === gecerliSifre) { document.getElementById('passwordModal').style.display = 'none'; openMode('kasa-authorized'); } 
        else { alert("‚õî Hatalƒ± ≈ûifre!"); document.getElementById("kasaSifreInput").value = ""; }
    }

    window.openPasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').style.display = 'block'; document.getElementById('eskiSifreInput').value = ''; document.getElementById('yeniSifreInput').value = '';
    }

    window.sifreyiVeritabanindaGuncelle = function() {
        const eski = document.getElementById('eskiSifreInput').value; const yeni = document.getElementById('yeniSifreInput').value; const mevcut = window.currentKasaSifre || "1234";
        if(eski !== mevcut) { alert("‚ùå Mevcut ≈üifre yanlƒ±≈ü!"); return; }
        if(yeni.length < 4) { alert("‚ö†Ô∏è ≈ûifre en az 4 hane olmalƒ±."); return; }
        window.saveNewPasswordToFirebase(yeni);
    }

    function masaKontrol() {
        const masa = document.getElementById("masaSecimi").value; const durumDiv = document.getElementById("masaDurumBilgisi");
        const aktifSiparis = Object.values(activeOrders).find(o => o.masa === masa);
        if (aktifSiparis) {
            let icerik = "<strong>Bu Masadaki √úr√ºnler:</strong><br>";
            if(aktifSiparis.urunler) aktifSiparis.urunler.forEach(u => icerik += `- ${u.ad}<br>`);
            icerik += `<br><strong>Toplam: ${aktifSiparis.toplam} ‚Ç∫</strong>`; durumDiv.innerHTML = icerik; durumDiv.style.display = "block";
        } else { durumDiv.style.display = "none"; }
    }

    window.renderMenu = function(menuList) {
        currentMenu = menuList; const containerID = isPaketMode ? "paketMenuContainer" : "menuContainer";
        const container = document.getElementById(containerID); if(!container) return; container.innerHTML = "";
        const grouped = {}; menuList.forEach(item => { if(!grouped[item.cat]) grouped[item.cat] = []; grouped[item.cat].push(item); });

        for (const [kategori, urunler] of Object.entries(grouped)) {
            const catBlock = document.createElement("div"); catBlock.className = "category-wrapper";
            const title = document.createElement("div"); title.className = "category-title"; title.innerHTML = `<span>${kategori}</span> <i class="fas fa-chevron-down"></i>`;
            const itemsContainer = document.createElement("div"); itemsContainer.className = "category-items"; 
            urunler.forEach(urun => {
                const div = document.createElement("div"); div.className = "menu-item";
                div.innerHTML = `<div class="menu-name">${urun.ad}</div><div class="menu-price">${urun.fiyat} ‚Ç∫</div>`;
                div.onclick = () => sepeteEkle(urun); itemsContainer.appendChild(div);
            });
            title.onclick = function() {
                const isCurrentlyOpen = itemsContainer.style.display === "grid";
                if(!isPaketMode) { document.querySelectorAll('#' + containerID + ' .category-items').forEach(el => el.style.display = 'none'); document.querySelectorAll('#' + containerID + ' .category-title i').forEach(el => el.className = 'fas fa-chevron-down'); }
                if (!isCurrentlyOpen) { itemsContainer.style.display = "grid"; this.querySelector('i').className = "fas fa-chevron-up"; } 
                else { itemsContainer.style.display = "none"; this.querySelector('i').className = "fas fa-chevron-down"; }
            };
            catBlock.appendChild(title); catBlock.appendChild(itemsContainer); container.appendChild(catBlock);
        }
    }

    window.urunAra = function() { aramaMotoru("urunArama", "menuContainer"); }
    window.urunAraPaket = function() { aramaMotoru("paketUrunArama", "paketMenuContainer"); }

    function aramaMotoru(inputId, containerId) {
        const input = document.getElementById(inputId); const filter = input.value.toUpperCase();
        const container = document.getElementById(containerId); const wrappers = container.getElementsByClassName("category-wrapper");
        if (filter === "") { for(let w of wrappers) { w.style.display = ""; w.getElementsByClassName("category-items")[0].style.display = "none"; } return; }
        for (let i = 0; i < wrappers.length; i++) {
            const wrapper = wrappers[i]; const itemsContainer = wrapper.getElementsByClassName("category-items")[0];
            const items = itemsContainer.getElementsByClassName("menu-item"); let hasMatch = false;
            for (let j = 0; j < items.length; j++) {
                const item = items[j]; const name = item.getElementsByClassName("menu-name")[0];
                if (name.innerText.toUpperCase().indexOf(filter) > -1) { item.style.display = "flex"; hasMatch = true; } else { item.style.display = "none"; }
            }
            if (hasMatch) { wrapper.style.display = ""; itemsContainer.style.display = "grid"; } else { wrapper.style.display = "none"; }
        }
    }

    function sepeteEkle(urun) { let eklenecekUrun = { ...urun, porsiyon: 1, baseFiyat: urun.fiyat }; sepet.push(eklenecekUrun); sepetiGuncelle(); }

    window.porsiyonDegistir = function(index, yeniPorsiyon) {
        let urun = sepet[index]; urun.porsiyon = parseFloat(yeniPorsiyon); urun.fiyat = urun.baseFiyat * urun.porsiyon;
        let temizAd = urun.ad.split(" (")[0]; if (urun.porsiyon !== 1) { urun.ad = `${temizAd} (${urun.porsiyon} Pors.)`; } else { urun.ad = temizAd; }
        sepetiGuncelle();
    }

    function sepetiGuncelle() {
        const toplamSpan = isPaketMode ? document.getElementById("paketSepetToplam") : document.getElementById("sepetToplam");
        const miniCart = isPaketMode ? document.getElementById("paketMiniCart") : document.getElementById("miniCart");
        const detayListe = document.getElementById("sepetListesi"); detayListe.innerHTML = ""; miniCart.innerHTML = ""; let toplam = 0;
        if (sepet.length > 0) {
            const ul = document.createElement("ul"); ul.className = "mini-cart-list";
            sepet.forEach((item, index) => {
                toplam += item.fiyat; let optionsHTML = "";
                for (let p = 1; p <= 5; p += 0.5) { let selected = item.porsiyon === p ? "selected" : ""; optionsHTML += `<option value="${p}" ${selected}>${p}</option>`; }
                const li = document.createElement("li");
                li.innerHTML = `<span>${item.ad.split(" (")[0]}</span> <select class="portion-select" style="width:70px;" onchange="porsiyonDegistir(${index}, this.value)">${optionsHTML}</select><span style="font-weight:bold; color:var(--primary); text-align:right;">${item.fiyat}‚Ç∫</span> <div class="del-item" onclick="sepettenCikar(${index})"><i class="fas fa-times"></i></div>`;
                detayListe.appendChild(li);
            });
        }
        toplamSpan.textContent = toplam;
    }

    function sepetiAc() { if(sepet.length > 0) { document.getElementById("sepetModal").style.display = "block"; document.getElementById("kuryeSecimDiv").style.display = "none"; }}
    function sepetiAcPaket() { if(sepet.length > 0) { document.getElementById("sepetModal").style.display = "block"; document.getElementById("kuryeSecimDiv").style.display = "block"; }}
    function sepettenCikar(index) { sepet.splice(index, 1); sepetiGuncelle(); if(sepet.length === 0) document.getElementById("sepetModal").style.display = "none"; }

    function firebasedenGonder() {
        if(!window.sendOrder) { alert("Sistem bekleniyor..."); return; }
        let masa, kurye, musteriTel, musteriIsim, musteriAdres;
        if (isPaketMode) {
            musteriTel = document.getElementById("paketTel").value; musteriIsim = document.getElementById("paketIsim").value; musteriAdres = document.getElementById("paketAdres").value; kurye = document.getElementById("kuryeSecimi").value;
            if(!musteriTel || musteriTel.length < 3) { alert("L√ºtfen telefon girin!"); return; }
            if(!musteriIsim) { alert("L√ºtfen isim girin!"); return; }
            if(!musteriAdres) { alert("L√ºtfen adres girin!"); return; }
            window.saveCustomerToFirebase(musteriTel, musteriIsim, musteriAdres); masa = `PAKET - ${musteriIsim}`;
        } else {
            masa = document.getElementById("masaSecimi").value; if (!masa) { alert("Masa se√ßilmedi!"); return; }
        }
        const not = document.getElementById("siparisNotu").value;
        const existingKey = !isPaketMode ? Object.keys(activeOrders).find(key => activeOrders[key].masa === masa) : null;
        if (existingKey) {
            const oldOrder = activeOrders[existingKey]; const newItems = oldOrder.urunler ? [...oldOrder.urunler, ...sepet] : [...sepet];
            const newTotal = newItems.reduce((a, b) => a + b.fiyat, 0);
            window.updateOrderInFirebase(existingKey, newItems, newTotal, 'hazirlaniyor', () => resetAfterSend());
        } else {
            const orderData = { masa: masa, urunler: sepet, not: not, isPaket: isPaketMode, kurye: isPaketMode ? kurye : null, musteri: isPaketMode ? { tel: musteriTel, isim: musteriIsim, adres: musteriAdres } : null, lastUpdated: Date.now() };
            window.sendOrder(orderData, () => resetAfterSend());
        }
    }

    function resetAfterSend() {
        sepet = []; sepetiGuncelle(); document.getElementById("sepetModal").style.display = "none"; document.getElementById("siparisNotu").value = "";
        if(isPaketMode) { document.getElementById("paketTel").value = ""; document.getElementById("paketIsim").value = ""; document.getElementById("paketAdres").value = ""; } 
        else { document.getElementById("masaSecimi").value = ""; document.getElementById("masaDurumBilgisi").style.display = "none"; }
        window.scrollTo(0,0);
    }

    window.musteriAra = function() {
        const tel = document.getElementById("paketTel").value;
        if(tel.length > 2) {
            window.findCustomerInFirebase(tel, (data) => {
                const isimInput = document.getElementById("paketIsim"); const adresInput = document.getElementById("paketAdres");
                if(data) { isimInput.value = data.isim; adresInput.value = data.adres; } 
            });
        }
    }

    window.siparisDuzenle = function(key) {
        const order = activeOrders[key]; if(!order) return;
        editingOrderKey = key; 
        editingItems = order.urunler.map(u => {
            let porsiyon = u.porsiyon || 1; let baseFiyat = u.baseFiyat;
            if (!baseFiyat) { baseFiyat = u.fiyat / porsiyon; }
            return { ...u, porsiyon: porsiyon, baseFiyat: baseFiyat, fiyat: u.fiyat };
        });
        const editPaketDiv = document.getElementById("editPaketBilgi"); const baslik = document.getElementById("editMasaBaslik");
        if(order.isPaket && order.musteri) {
            editPaketDiv.style.display = "block"; baslik.innerHTML = `<i class="fas fa-motorcycle"></i> ${order.kurye || '?'} - ${order.musteri.isim}`;
            document.getElementById("editPaketIsim").value = order.musteri.isim; document.getElementById("editPaketAdres").value = order.musteri.adres;
        } else {
            editPaketDiv.style.display = "none"; baslik.innerText = order.masa;
        }
        initEditDropdown(); renderEditList(); document.getElementById("editModal").style.display = "block";
    }

    function renderEditList() {
        const list = document.getElementById("editList"); const totalSpan = document.getElementById("editTotal"); list.innerHTML = ""; let total = 0;
        editingItems.forEach((item, index) => {
            total += item.fiyat; let porsiyonOptions = "";
            [1, 1.5, 2, 2.5, 3].forEach(p => { let selected = item.porsiyon === p ? "selected" : ""; porsiyonOptions += `<option value="${p}" ${selected}>${p}</option>`; });
            let safAd = item.ad.split(" (")[0];
            const li = document.createElement("li"); li.style.gridTemplateColumns = "2fr 1fr 1fr 0.5fr"; 
            li.innerHTML = `<span>${safAd}</span> <select class="portion-select" onchange="editItemPorsiyonDegistir(${index}, this.value)">${porsiyonOptions}</select><div style="text-align:right; font-weight:bold; color:var(--primary);">${item.fiyat}‚Ç∫</div><div class="del-item" onclick="editUrunSil(${index})"><i class="fas fa-trash"></i></div>`;
            list.appendChild(li);
        });
        totalSpan.textContent = total;
    }

    window.editUrunEkle = function() {
        const select = document.getElementById("editMenuSelect"); const porsiyonSelect = document.getElementById("editYeniUrunPorsiyon");
        if(select.value === "") { alert("L√ºtfen listeden bir √ºr√ºn se√ßin."); return; }
        const rawItem = JSON.parse(select.value); const secilenPorsiyon = parseFloat(porsiyonSelect.value);
        const newItem = { cat: rawItem.cat, baseFiyat: rawItem.fiyat, porsiyon: secilenPorsiyon, fiyat: rawItem.fiyat * secilenPorsiyon, ad: rawItem.ad };
        if(secilenPorsiyon !== 1) { newItem.ad = `${newItem.ad} (${secilenPorsiyon} Pors.)`; }
        editingItems.push(newItem); renderEditList();
    }

    window.editItemPorsiyonDegistir = function(index, yeniPorsiyon) {
        const item = editingItems[index]; const p = parseFloat(yeniPorsiyon);
        item.porsiyon = p; item.fiyat = item.baseFiyat * p; let safAd = item.ad.split(" (")[0];
        if (p !== 1) { item.ad = `${safAd} (${p} Pors.)`; } else { item.ad = safAd; }
        renderEditList();
    }

    function initEditDropdown() {
        const select = document.getElementById("editMenuSelect"); select.innerHTML = '<option value="">√úr√ºn Se√ßiniz...</option>';
        let sortedMenu = [...currentMenu].sort((a, b) => a.ad.localeCompare(b.ad));
        sortedMenu.forEach(item => { const option = document.createElement("option"); option.value = JSON.stringify(item); option.text = `${item.ad} - ${item.fiyat} ‚Ç∫`; select.appendChild(option); });
        document.getElementById("editYeniUrunPorsiyon").value = "1";
    }

    window.editUrunSil = function(index) { editingItems.splice(index, 1); renderEditList(); }

    window.editKaydet = function() {
        if(!window.updateFullOrderInFirebase) { alert("Veritabanƒ± baƒülantƒ±sƒ± yok!"); return; }
        if(confirm("Deƒüi≈üiklikler kaydedilsin mi?")) {
            const newTotal = editingItems.reduce((acc, item) => acc + item.fiyat, 0); const currentOrder = activeOrders[editingOrderKey]; let updatedMusteri = null;
            if(currentOrder.isPaket) {
                const yeniIsim = document.getElementById("editPaketIsim").value; const yeniAdres = document.getElementById("editPaketAdres").value;
                updatedMusteri = { ...(currentOrder.musteri || {}), isim: yeniIsim, adres: yeniAdres };
                if(updatedMusteri.tel) { window.saveCustomerToFirebase(updatedMusteri.tel, yeniIsim, yeniAdres); }
            } else { updatedMusteri = currentOrder.musteri || null; }
            window.updateFullOrderInFirebase(editingOrderKey, editingItems, newTotal, updatedMusteri, () => { document.getElementById("editModal").style.display = "none"; editingItems = []; editingOrderKey = null; });
        }
    }

    window.editSiparisiIptal = function() {
        if(confirm("Dƒ∞KKAT! Bu sipari≈ü tamamen silinecek.")) { window.cancelOrderInFirebase(editingOrderKey, () => { document.getElementById("editModal").style.display = "none"; }); }
    }

    window.openMenuManager = function() {
        const filterSelect = document.getElementById("filterCategory"); filterSelect.innerHTML = '<option value="all">üîç T√úM KATEGORƒ∞LER</option>';
        CATEGORIES.forEach(cat => { const op = document.createElement("option"); op.value = cat; op.text = cat; filterSelect.appendChild(op); });
        renderMenuManageTable(); document.getElementById("menuManageModal").style.display = "block";
        const tbody = document.getElementById("menuManageBody"); new Sortable(tbody, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { updateMenuOrderFromDOM(); } });
    }
    
    window.deleteCategory = function() {
        const filterSelect = document.getElementById("filterCategory"); const selectedCat = filterSelect.value;
        if (selectedCat === "all") { alert("L√ºtfen silmek istediƒüiniz kategoriyi yukarƒ±daki listeden se√ßiniz."); return; }
        if (confirm(`"${selectedCat}" kategorisini silmek istediƒüinize emin misiniz?`)) {
            const catIndex = CATEGORIES.indexOf(selectedCat);
            if (catIndex > -1) { CATEGORIES.splice(catIndex, 1); window.saveCategoriesToFirebase(); alert("Kategori silindi!"); window.openMenuManager(); }
        }
    }

    function renderMenuManageTable() {
        const tbody = document.getElementById("menuManageBody"); const filter = document.getElementById("filterCategory").value; tbody.innerHTML = "";
        currentMenu.forEach((item, index) => {
            if(filter !== 'all' && item.cat !== filter) return;
            const tr = document.createElement("tr"); tr.setAttribute("data-index", index); 
            let categorySelect = `<select class="table-select" style="padding:8px;" onchange="updateMenuItem(${index}, 'cat', this.value)">`;
            CATEGORIES.forEach(c => { categorySelect += `<option value="${c}" ${c === item.cat ? 'selected' : ''}>${c}</option>`; }); categorySelect += `</select>`;
            tr.innerHTML = `<td class="drag-handle">‚ò∞</td><td>${categorySelect}</td><td><input type="text" class="table-select" style="padding:8px;" value="${item.ad}" onchange="updateMenuItem(${index}, 'ad', this.value)"></td><td><input type="number" class="table-select" style="padding:8px;" value="${item.fiyat}" onchange="updateMenuItem(${index}, 'fiyat', this.value)"></td><td style="text-align:center;"><span class="del-item" onclick="deleteMenuItem(${index})">X</span></td>`;
            tbody.appendChild(tr);
        });
    }
    function updateMenuOrderFromDOM() {
        const rows = document.querySelectorAll('#menuManageBody tr'); const newOrderIndices = Array.from(rows).map(row => parseInt(row.getAttribute('data-index')));
        const availableSlots = [...newOrderIndices].sort((a, b) => a - b); const oldMenu = [...currentMenu];
        availableSlots.forEach((slotIndex, i) => { const oldIndex = newOrderIndices[i]; currentMenu[slotIndex] = oldMenu[oldIndex]; }); renderMenuManageTable(); 
    }
    window.updateMenuItem = function(index, field, value) { if(field === 'fiyat') value = Number(value); currentMenu[index][field] = value; }
    window.deleteMenuItem = function(index) { if(confirm("Sil?")) { currentMenu.splice(index, 1); renderMenuManageTable(); } }
    window.addNewMenuRow = function() {
        const filter = document.getElementById("filterCategory").value; currentMenu.push({ cat: filter !== 'all' ? filter : CATEGORIES[0], ad: "Yeni √úr√ºn", fiyat: 0 }); renderMenuManageTable();
    }
    window.addNewCategory = function() {
        const cat = prompt("Yeni Kategori:"); if(cat && !CATEGORIES.includes(cat)) { CATEGORIES.push(cat); window.saveCategoriesToFirebase(); window.openMenuManager(); }
    }
    window.saveMenuChanges = function() {
        if(confirm("Kaydet?")) { window.saveMenuToFirebase(currentMenu, () => { document.getElementById("menuManageModal").style.display = "none"; window.renderMenu(currentMenu); }); }
    }
    
    window.toggleCard = function(key) {
        collapsedStates[key] = !collapsedStates[key]; const card = document.getElementById('card-' + key); const icon = document.getElementById('icon-' + key);
        if(card && icon) { if(collapsedStates[key]) { card.classList.add('card-collapsed'); icon.className = "fas fa-eye-slash toggle-icon"; } else { card.classList.remove('card-collapsed'); icon.className = "fas fa-eye toggle-icon"; } }
        event.stopPropagation();
    }

    window.fisiYazdir = function(key) {
        const siparis = activeOrders[key]; if (!siparis) return;
        const printArea = document.getElementById("print-area");
        let header = "MUTENA ADƒ∞SYON"; let subHeader = siparis.isPaket ? `Paket: ${siparis.musteri.isim}` : `Masa: ${siparis.masa}`; let tarih = `${siparis.tarih} ${siparis.saat}`;
        let deliveryInfo = "";
        if (siparis.isPaket && siparis.musteri) { deliveryInfo = `<div class="print-delivery"><div>Tel: ${siparis.musteri.tel || '-'}</div><div>Adres: ${siparis.musteri.adres || '-'}</div></div>`; }
        let itemsHTML = "";
        siparis.urunler.forEach(u => {
            let porsiyon = (u.porsiyon && u.porsiyon !== 1) ? `(${u.porsiyon})` : "";
            itemsHTML += `<tr><td>${u.ad} ${porsiyon}</td><td style="text-align:right;">${u.fiyat} ‚Ç∫</td></tr>`;
        });
        let notHTML = siparis.not ? `<div style="margin-top:10px; border-top:1px dashed #000; padding-top:5px;"><strong>Not:</strong> ${siparis.not}</div>` : "";
        printArea.innerHTML = `<div class="print-header"><h2 class="print-title">${header}</h2><div class="print-info">${tarih}</div><div class="print-info" style="font-size:14px; font-weight:bold;">${subHeader}</div></div>${deliveryInfo}<table class="print-table">${itemsHTML}</table><div class="print-total">TOPLAM: ${siparis.toplam} ‚Ç∫</div>${notHTML}<div class="print-footer">Afiyet Olsun!</div>`;
        window.print();
    }

    window.showReadyOrdersModal = function() {
        const container = document.getElementById("readyOrdersList"); container.innerHTML = "";
        Object.keys(activeOrders).forEach(key => {
            const siparis = activeOrders[key]; if(siparis.durum !== 'hazir') return; 
            let isRelevant = false;
            if (currentUserMode === 'paket' && siparis.isPaket) isRelevant = true;
            else if (currentUserMode === 'alt' && !siparis.isPaket) { let masaNo = parseInt(siparis.masa.replace("Masa ", "")); if (masaNo > 18) isRelevant = true; }
            else if (currentUserMode === 'ust' && !siparis.isPaket) { let masaNo = parseInt(siparis.masa.replace("Masa ", "")); if (masaNo <= 18) isRelevant = true; }
            if(isRelevant) {
                const urunler = siparis.urunler || []; let urunHTML = "";
                urunler.forEach(u => { let porsiyonText = (u.porsiyon && u.porsiyon !== 1) ? ` (${u.porsiyon} Pors.)` : ""; urunHTML += `<li>‚úÖ ${u.ad.split(" (")[0]}${porsiyonText}</li>`; });
                let baslik = siparis.isPaket ? `üõµ ${siparis.kurye || '?'} - ${siparis.musteri.isim}` : `${siparis.masa}`;
                container.innerHTML += `<div class="order-card" style="border-left:5px solid var(--success);"><div class="order-header">${baslik} <span style="font-size:13px; color:#888">${siparis.hazir_saat || ''}</span></div><ul class="order-list-compact">${urunHTML}</ul></div>`;
            }
        });
        if(container.innerHTML === "") { container.innerHTML = "<p style='text-align:center; color:var(--text-muted);'>Hazƒ±r sipari≈ü bulunmuyor.</p>"; }
        document.getElementById("readyOrdersModal").style.display = "block";
    }
/* --- M√ú≈ûTERƒ∞ Y√ñNETƒ∞Mƒ∞ (D√úZELTƒ∞LMƒ∞≈û VE ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û) --- */
    
    // Veriyi global deƒüi≈ükene atƒ±yoruz ki her yerden eri≈üilebilsin
    window.allCustomersData = {}; 

    window.openCustomerList = function() {
        if(!window.fetchAllCustomers) { alert("Veritabanƒ± baƒülantƒ±sƒ± bekleniyor..."); return; }
        
        window.fetchAllCustomers((data) => {
            window.allCustomersData = data || {}; // Veriyi global kaydet
            renderCustomerList(window.allCustomersData);
            document.getElementById("customerListModal").style.display = "block";
        });
    }

    window.renderCustomerList = function(data) {
        const list = document.getElementById("customerList");
        list.innerHTML = "";
        
        if(!data || Object.keys(data).length === 0) {
            list.innerHTML = "<li style='text-align:center; padding:15px; color:#999;'>Kayƒ±tlƒ± m√º≈üteri bulunamadƒ±.</li>";
            return;
        }

        Object.entries(data)
            .sort(([,a], [,b]) => (a.isim || "").localeCompare(b.isim || ""))
            .forEach(([tel, info]) => {
                const li = document.createElement("li");
                li.style.cssText = "border-bottom:1px solid #f1f5f9; padding:12px 0;";
                
                const isim = info.isim || 'ƒ∞simsiz';
                const adres = info.adres || 'Adres Girilmemi≈ü';
                const son = info.sonSiparis || '-';

                li.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:var(--text-main); font-size:15px;">${isim}</div>
                            <div style="color:var(--primary); font-size:13px; margin-top:2px;">
                                <i class="fas fa-phone"></i> ${tel}
                            </div>
                            <div style="font-size:12px; color:#64748b; margin-top:5px; line-height:1.4;">
                                <i class="fas fa-map-marker-alt"></i> ${adres}
                            </div>
                        </div>
                        
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px; margin-left:10px;">
                            <div style="font-size:10px; background:#f1f5f9; padding:2px 6px; border-radius:4px; color:#666;">
                                ${son}
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="openEditCustomerModal('${tel}')" style="background:#3b82f6; color:white; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button onclick="deleteCustomerFromDb('${tel}')" style="background:#ef4444; color:white; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(li);
        });
    }

    window.filterCustomers = function() {
        const query = document.getElementById("customerSearchInput").value.toLowerCase();
        const filtered = {};
        
        Object.entries(window.allCustomersData).forEach(([tel, info]) => {
            const isim = (info.isim || "").toLowerCase();
            const telefon = tel.toLowerCase();
            const adres = (info.adres || "").toLowerCase();
            
            if (isim.includes(query) || telefon.includes(query) || adres.includes(query)) {
                filtered[tel] = info;
            }
        });
        renderCustomerList(filtered);
    }

    // YENƒ∞ EKLEME PENCERESƒ∞Nƒ∞ A√á
    window.openAddCustomerModal = function() {
        document.getElementById("custFormTitle").innerText = "Yeni M√º≈üteri Ekle";
        document.getElementById("custFormTel").value = "";
        document.getElementById("custFormTel").disabled = false; 
        document.getElementById("custFormName").value = "";
        document.getElementById("custFormAddr").value = "";
        document.getElementById("customerFormModal").style.display = "block";
    }

    // D√úZENLEME PENCERESƒ∞Nƒ∞ A√á (ARTIK √áALI≈ûACAK)
    window.openEditCustomerModal = function(tel) {
        // Global veriden m√º≈üteriyi buluyoruz
        const info = window.allCustomersData[tel];
        
        if(!info) {
            alert("Hata: M√º≈üteri bilgisi bulunamadƒ±.");
            return;
        }

        document.getElementById("custFormTitle").innerText = "M√º≈üteri D√ºzenle";
        document.getElementById("custFormTel").value = tel;
        document.getElementById("custFormTel").disabled = true; // Telefon anahtar olduƒüu i√ßin deƒüi≈ütirilemez
        document.getElementById("custFormName").value = info.isim || "";
        document.getElementById("custFormAddr").value = info.adres || "";
        document.getElementById("customerFormModal").style.display = "block";
    }

    window.saveCustomerToDb = function() {
        const tel = document.getElementById("custFormTel").value.trim();
        const isim = document.getElementById("custFormName").value.trim();
        const adres = document.getElementById("custFormAddr").value.trim();

        if(tel.length < 3 || isim.length < 2) {
            alert("L√ºtfen ge√ßerli bir telefon ve isim giriniz.");
            return;
        }

        let sonSiparis = new Date().toLocaleDateString();
        // Eƒüer mevcut bir m√º≈üteriyse eski tarihini koru
        if(window.allCustomersData[tel] && window.allCustomersData[tel].sonSiparis) {
            sonSiparis = window.allCustomersData[tel].sonSiparis;
        }

        if(window.saveCustomerDataDirectly) {
            window.saveCustomerDataDirectly(tel, isim, adres, sonSiparis);
        }
    }

    window.deleteCustomerFromDb = function(tel) {
        if(confirm(tel + " numaralƒ± m√º≈üteriyi silmek istediƒüinize emin misiniz?")) {
            if(window.deleteCustomerDataDirectly) {
                window.deleteCustomerDataDirectly(tel);
            }
        }
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCj9AGZsqvxMCmzrJDFUbj1teFd5st3IeQ",
        authDomain: "mutena-dijital-adisyon-becab.firebaseapp.com",
        databaseURL: "https://mutena-dijital-adisyon-becab-default-rtdb.firebaseio.com",
        projectId: "mutena-dijital-adisyon-becab",
        storageBucket: "mutena-dijital-adisyon-becab.firebasestorage.app",
        messagingSenderId: "68716658785",
        appId: "1:68716658785:web:ced487b01fe98a15b5aa20",
        measurementId: "G-26NWRGRVW4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.currentKasaSifre = "1234";
    const settingsRef = ref(db, 'settings/kasaSifresi');
    onValue(settingsRef, (snapshot) => {
        if (snapshot.exists()) { window.currentKasaSifre = snapshot.val().toString(); } else { set(settingsRef, "1234"); }
    });
    window.saveNewPasswordToFirebase = function(newPass) {
        set(settingsRef, newPass).then(() => { alert("‚úÖ ≈ûifre deƒüi≈ütirildi!"); document.getElementById('passwordChangeModal').style.display = 'none'; });
    }
// --- BU KODU SCRIPT TYPE="MODULE" ƒ∞√áƒ∞NE EKLE ---
    window.fetchAllCustomers = function(callback) {
        get(ref(db, 'musteriler')).then((snapshot) => {
            if (snapshot.exists()) {
                callback(snapshot.val());
            } else {
                callback({});
            }
        });
    }

    window.findCustomerInFirebase = function(tel, callback) {
        get(ref(db, 'musteriler/' + tel)).then((snapshot) => {
            if(snapshot.exists()) { callback(snapshot.val()); } else { callback(null); }
        });
    }
    window.saveCustomerToFirebase = function(tel, isim, adres) {
        set(ref(db, 'musteriler/' + tel), { isim: isim, adres: adres, sonSiparis: new Date().toLocaleDateString() });
    }

    window.fetchMenu = function() {
        const menuRef = ref(db, 'menu');
        get(menuRef).then((snapshot) => {
            if (snapshot.exists()) { window.renderMenu(snapshot.val()); } 
        });
        onValue(menuRef, (snapshot) => { if (snapshot.exists()) { window.renderMenu(snapshot.val()); } });
        get(ref(db, 'categories')).then(snap => { if(snap.exists()) CATEGORIES = snap.val(); else set(ref(db, 'categories'), CATEGORIES); });
    }
    window.saveMenuToFirebase = function(newMenu, callback) { set(ref(db, 'menu'), newMenu).then(() => { alert("G√ºncellendi!"); callback(); }); }
    window.saveCategoriesToFirebase = function() { set(ref(db, 'categories'), CATEGORIES); }

    window.sendOrder = function(orderData, callback) {
        const siparisRef = ref(db, 'siparisler');
        const yeniSiparis = {
            ...orderData, durum: 'hazirlaniyor',
            toplam: orderData.urunler.reduce((a, b) => a + b.fiyat, 0),
            tarih: new Date().toLocaleDateString('tr-TR'),
            saat: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}),
            lastUpdated: Date.now()
        };
        push(siparisRef, yeniSiparis).then(() => { alert("‚úÖ ƒ∞letildi!"); callback(); });
    }

    window.updateOrderInFirebase = function(key, newItems, newTotal, status, callback) {
        update(ref(db, 'siparisler/' + key), { urunler: newItems, toplam: newTotal, durum: status, lastUpdated: Date.now() }).then(() => { alert("‚úÖ G√ºncellendi!"); callback(); });
    }
    
    // G√úNCELLENEN FIREBASE FONKSƒ∞YONU (Hata korumalƒ± ve Zaman damgalƒ±)
    window.updateFullOrderInFirebase = function(key, newItems, newTotal, musteriData, callback) {
        const siparisRef = ref(db, 'siparisler/' + key);
        
        const updateData = { 
            urunler: newItems, 
            toplam: newTotal,
            lastUpdated: Date.now()
        };

        if (musteriData) {
            updateData.musteri = musteriData;
        }

        update(siparisRef, updateData)
            .then(() => { 
                alert("‚úÖ Sipari≈ü Ba≈üarƒ±yla G√ºncellendi!"); 
                if(callback) callback(); 
            })
            .catch((error) => {
                console.error(error);
                alert("‚ùå HATA: Kayƒ±t yapƒ±lamadƒ±! " + error.message);
            });
    }

    window.cancelOrderInFirebase = function(key, callback) {
        remove(ref(db, 'siparisler/' + key)).then(() => { alert("üóëÔ∏è Silindi."); callback(); });
    }

    // ANA Dƒ∞NLEYƒ∞Cƒ∞ (T√ºm sipari≈üleri tek seferde √ßeker, bildirimleri y√∂netir)
    onValue(ref(db, 'siparisler'), (snapshot) => {
        const data = snapshot.val(); 
        activeOrders = data || {}; 
        
        if(document.getElementById("garson-panel").style.display === "block") {
            if(window.checkTableStatus) window.checkTableStatus();
            if(document.getElementById("masaSecimi").value) masaKontrol();
        }

        if(document.getElementById("kasa-panel").style.display === "block") {
            window.siparisleriGetir();
        }

        if(document.getElementById("mutfak-panel").style.display === "block") {
            window.mutfakSiparisleriGuncelle();
        }

        window.checkReadyNotifications();
    });

    window.checkTableStatus = function() {
        const select = document.getElementById("masaSecimi"); 
        if(select) {
            for (let i = 0; i < select.options.length; i++) {
                const opt = select.options[i]; if (opt.value === "") continue;
                const isActive = Object.values(activeOrders).some(o => o.masa === opt.value);
                if(isActive) { 
                    opt.classList.add('busy-table'); 
                    if(!opt.text.includes("(DOLU)")) opt.text = opt.value + " (DOLU)"; 
                } 
                else { 
                    opt.classList.remove('busy-table'); 
                    opt.text = opt.value; 
                }
            }
        }
    }

    window.checkReadyNotifications = function() {
        if (!currentUserMode) return; 

        let readyCount = 0;
        Object.values(activeOrders).forEach(siparis => {
            if (siparis.durum !== 'hazir') return;
            if (currentUserMode === 'paket' && siparis.isPaket) readyCount++;
            else if (currentUserMode === 'alt' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo > 18) readyCount++;
            }
            else if (currentUserMode === 'ust' && !siparis.isPaket) {
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                if (masaNo <= 18) readyCount++;
            }
        });

        const badge = document.getElementById("notificationBadge");
        if (readyCount > 0) {
            badge.style.display = "block";
            badge.innerText = readyCount;
            if (readyCount > previousReadyCount) { playNotificationSound(); }
        } else { badge.style.display = "none"; }
        previousReadyCount = readyCount;
    }

    window.mutfakSiparisleriGuncelle = function() {
        const data = activeOrders;
        const container = document.getElementById("mutfakContainer");
        
        if(container) { 
            container.innerHTML = "";
            if (!data) { container.innerHTML = "<p style='text-align:center;'>Sipari≈ü yok.</p>"; return; } 

            const altDiv = document.createElement("div"); altDiv.className = "floor-section";
            altDiv.innerHTML = '<div class="floor-title bg-alt" style="color:#d97706; background:#fffbeb; border:1px solid #fcd34d;">‚¨áÔ∏è ALT KAT</div><div class="kitchen-order-container" id="mutfak-alt"></div>';
            
            const ustDiv = document.createElement("div"); ustDiv.className = "floor-section";
            ustDiv.innerHTML = '<div class="floor-title bg-ust" style="color:#7c3aed; background:#f5f3ff; border:1px solid #c4b5fd;">‚¨ÜÔ∏è √úST KAT</div><div class="kitchen-order-container" id="mutfak-ust"></div>';

            const paketDiv = document.createElement("div"); paketDiv.className = "floor-section";
            paketDiv.innerHTML = '<div class="floor-title bg-paket" style="color:#2563eb; background:#eff6ff; border:1px solid #bfdbfe;">üõµ PAKET SERVƒ∞S</div><div class="kitchen-order-container" id="mutfak-paket"></div>';

            container.appendChild(altDiv); container.appendChild(ustDiv); container.appendChild(paketDiv);

            // SIRALAMA MANTIƒûI
            const sortedOrders = Object.entries(data).sort((a, b) => (b[1].lastUpdated || 0) - (a[1].lastUpdated || 0));

            sortedOrders.forEach(([key, siparis]) => {
                const yemekler = siparis.urunler ? siparis.urunler.filter(u => u.cat !== 'ƒ∞√áECEKLER') : [];
                if (yemekler.length === 0) return; 

                const isOrderDone = siparis.durum === 'hazir';
                
                let isCollapsed = collapsedStates[key];
                if (isCollapsed === undefined) { isCollapsed = isOrderDone; }
                
                let cardClass = isOrderDone ? "order-card kitchen-card order-done" : "order-card kitchen-card";
                if(isCollapsed) cardClass += " card-collapsed";
                let iconClass = isCollapsed ? "fas fa-eye-slash toggle-icon" : "fas fa-eye toggle-icon";

                let urunHTML = "";
                yemekler.forEach(u => {
                    let displayName = u.ad.replace(/ \(\d+(\.\d+)? Pors\.\)$/, "");
                    if(u.porsiyon && u.porsiyon != 1) {
                        displayName += ` <span style='color:var(--danger); font-weight:bold;'>(${u.porsiyon} Pors.)</span>`;
                    }

                    if(isOrderDone || u.hazir) {
                        urunHTML += `<li class="kitchen-item-ready" style="color:#94a3b8; text-decoration:line-through; font-weight:bold;">‚úÖ ${displayName}</li>`;
                    } else {
                        urunHTML += `<li class="kitchen-item-new">üî• ${displayName}</li>`;
                    }
                });

                let notHTML = siparis.not ? `<div style='background:#fff3cd; padding:5px; margin-top:5px; border-radius:5px; font-weight:bold;'>üìù ${siparis.not}</div>` : "";
                let paketBilgi = "";
                let baslik = "";
                let targetGrid;
                
                if(siparis.isPaket) {
                    targetGrid = document.getElementById("mutfak-paket");
                    baslik = `<span style="font-size:15px;">${siparis.kurye || '?'} - ${siparis.musteri.isim}</span>`;
                    paketBilgi = `<div class="order-details-wrapper" style="font-size:12px; color:#666; margin-top:5px; border-top:1px dashed #ccc;">üìç ${siparis.musteri.adres}</div>`;
                } else {
                    baslik = `<span style="font-size:20px;">${siparis.masa}</span>`;
                    let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                    if (masaNo >= 1 && masaNo <= 18) { targetGrid = document.getElementById("mutfak-ust"); } 
                    else { targetGrid = document.getElementById("mutfak-alt"); }
                }

let butonHTML = "";
                if(isOrderDone) {
                    // Sipari≈ü hazƒ±rsa ye≈üil kutu g√∂ster
                    butonHTML = `<div class="order-details-wrapper kitchen-ready-msg" style="margin-top:10px; background:#27ae60; color:white; text-align:center; padding:10px; border-radius:8px; font-weight:bold;">‚úÖ SERVƒ∞SE HAZIR<br><span style="font-size:11px;">${siparis.hazir_saat}</span></div>`;
                } else {
                    // Sipari≈ü hazƒ±r deƒüilse YAZDIR ve HAZIRLA butonlarƒ±nƒ± yan yana koy
                    butonHTML = `
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button class="action-btn-sm btn-print" onclick="fisiYazdir('${key}')" style="padding:10px; font-size:14px; flex:1;">
                                <i class="fas fa-print"></i> YAZDIR
</button>
                            
                            <button class="ready-btn" onclick="siparisiHazirla('${key}')" 
                                style="flex:1.5; margin:0; padding:12px; font-size:14px; border-radius:10px; display:flex; align-items:center; justify-content:center; gap:8px; background:var(--success); color:white; border:none; font-weight:800; box-shadow:0 4px 10px rgba(16, 185, 129, 0.3); cursor:pointer; transition:transform 0.2s;">
                                <i class="fas fa-check"></i> HAZIRLA
                            </button>
                        </div>
                    `;
                }
                const cardHTML = `
                    <div id="card-${key}" class="${cardClass}">
                        <div class="order-header" style="margin-bottom:5px;">
                            ${baslik} 
                            <i id="icon-${key}" class="${iconClass}" onclick="toggleCard('${key}')"></i>
                            <span class="order-details-wrapper" style="font-size:14px; color:#666; float:right; margin-right:10px;">${siparis.saat}</span>
                        </div>
                        <ul class="order-list-compact" style="margin-bottom:10px;">${urunHTML}</ul>
                        <div class="order-details-wrapper">${notHTML}</div>
                        ${paketBilgi}
                        ${butonHTML}
                    </div>
                `;

                if(targetGrid) targetGrid.innerHTML += cardHTML;
            });
        }
    }

    window.siparisiHazirla = async function(key) {
        const snap = await get(ref(db, 'siparisler/' + key));
        if (snap.exists()) {
            const order = snap.val();
            const updated = order.urunler.map(u => { if(u.cat !== 'ƒ∞√áECEKLER') return { ...u, hazir: true }; return u; });
            update(ref(db, 'siparisler/' + key), { urunler: updated, durum: 'hazir', hazir_saat: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit'}), lastUpdated: Date.now() });
        }
    }

    window.siparisleriGetir = function() {
        const data = activeOrders;
        const container = document.getElementById("kasaContainer");
        if(container) {
            container.innerHTML = ""; 
            if (!data) { container.innerHTML = "<p style='text-align:center;'>Sipari≈ü yok.</p>"; return; }

            const altDiv = document.createElement("div"); altDiv.className = "floor-section";
            altDiv.innerHTML = '<div class="floor-title bg-alt" style="color:#d97706; background:#fffbeb; border:1px solid #fcd34d;">‚¨áÔ∏è ALT KAT</div><div class="order-container" id="grid-alt"></div>';
            
            const ustDiv = document.createElement("div"); ustDiv.className = "floor-section";
            ustDiv.innerHTML = '<div class="floor-title bg-ust" style="color:#7c3aed; background:#f5f3ff; border:1px solid #c4b5fd;">‚¨ÜÔ∏è √úST KAT</div><div class="order-container" id="grid-ust"></div>';

            const paketDiv = document.createElement("div"); paketDiv.className = "floor-section";
            paketDiv.innerHTML = '<div class="floor-title bg-paket" style="color:#2563eb; background:#eff6ff; border:1px solid #bfdbfe;">üõµ PAKET SERVƒ∞S</div><div class="order-container" id="grid-paket"></div>';

            container.appendChild(altDiv); container.appendChild(ustDiv); container.appendChild(paketDiv);
            
            const sortedOrders = Object.entries(data).sort((a, b) => (b[1].lastUpdated || 0) - (a[1].lastUpdated || 0));

            sortedOrders.forEach(([key, siparis]) => {
                let targetGrid, cardClass;
                if (siparis.isPaket) { targetGrid = document.getElementById("grid-paket"); cardClass = "card-paket"; } 
                else {
                    let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                    if (masaNo >= 1 && masaNo <= 18) { targetGrid = document.getElementById("grid-ust"); cardClass = "card-ust"; }
                    else { targetGrid = document.getElementById("grid-alt"); cardClass = "card-alt"; }
                }
                
                let urunHTML = "";
                siparis.urunler.forEach(u => { 
                    let displayName = u.ad.replace(/ \(\d+(\.\d+)? Pors\.\)$/, "");
                    if(u.porsiyon && u.porsiyon != 1) {
                        displayName += ` <span style="color:#d35400; font-weight:bold; font-size:12px;">(${u.porsiyon} Pors.)</span>`;
                    }

                    urunHTML += `<li style="display:flex; justify-content:space-between; align-items:center;">
                        <div>${displayName}</div> 
                        <div style="font-weight:bold;">${u.fiyat}‚Ç∫</div>
                    </li>`; 
                });
                
                let header = siparis.isPaket ? `<span>üõµ ${siparis.kurye} - ${siparis.musteri.isim}</span>` : `<span>${siparis.masa}</span>`;
                let adresBilgi = siparis.isPaket ? `<div style='font-size:11px; color:#555; margin-bottom:5px;'>${siparis.musteri.adres}</div>` : "";
                
                const div = document.createElement("div"); div.className = `order-card ${cardClass}`;
                div.innerHTML = `<div class="order-header">${header} <span style="font-size:13px; color:#888">${siparis.saat}</span></div>${adresBilgi}<div class="order-list-container"><ul class="order-list-compact">${urunHTML}</ul></div><div class="total-price-compact">TOPLAM: ${siparis.toplam} ‚Ç∫</div><div class="action-buttons"><button class="action-btn-sm btn-print" onclick="fisiYazdir('${key}')"><i class="fas fa-print"></i> YAZDIR</button><button class="action-btn-sm btn-edit" onclick="siparisDuzenle('${key}')"><i class="fas fa-edit"></i> D√úZENLE</button><button class="action-btn-sm btn-pay" onclick="hesabiKapat('${key}')"><i class="fas fa-wallet"></i> √ñDENDƒ∞</button></div>`;
                if(targetGrid) targetGrid.appendChild(div);
            });
        }
    }

    window.hesabiKapat = async function(key) {
        if(confirm("Hesap √∂dendi mi?")) {
            const snap = await get(ref(db, 'siparisler/' + key));
            if(snap.exists()) { await push(ref(db, 'arsiv'), snap.val()); await remove(ref(db, 'siparisler/' + key)); }
        }
    }

    window.raporlariAc = function() {
        document.getElementById("kasa-panel").style.display = "none"; document.getElementById("rapor-panel").style.display = "block";
        get(ref(db, 'arsiv')).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                let ciro = 0; let sayim = {}; let masaSayisi = 0; let kuryeCiro = {}; 
                Object.values(data).forEach(s => {
                    ciro += s.toplam; masaSayisi++;
                    if(s.urunler) s.urunler.forEach(u => { let temizAd = u.ad.split(" (")[0]; sayim[temizAd] = (sayim[temizAd] || 0) + (u.porsiyon || 1); });
                    if(s.isPaket && s.kurye) { kuryeCiro[s.kurye] = (kuryeCiro[s.kurye] || 0) + s.toplam; }
                });
                document.getElementById("gunlukCiro").innerText = ciro + " ‚Ç∫"; document.getElementById("toplamMasa").innerText = masaSayisi;
                const liste = document.getElementById("satilanUrunlerListesi"); liste.innerHTML = "";
                Object.entries(sayim).sort((a,b)=>b[1]-a[1]).forEach(([ad, adet]) => { liste.innerHTML += `<li style='border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; font-size:14px;'><span>${ad}</span> <b>${adet} Pors.</b></li>`; });
                const kuryeListesi = document.getElementById("kuryeRaporListesi"); kuryeListesi.innerHTML = "";
                if(Object.keys(kuryeCiro).length === 0) { kuryeListesi.innerHTML = "<span style='color:#999'>Hen√ºz paket teslimatƒ± yok.</span>"; } 
                else { Object.entries(kuryeCiro).forEach(([isim, tutar]) => { kuryeListesi.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #f0f0f0;"><span style="font-weight:600;"><i class="fas fa-user-helmet-safety"></i> ${isim}</span><span style="color:var(--success); font-weight:800;">${tutar} ‚Ç∫</span></div>`; }); }
            }
        });
    }

    window.raporlariSifirla = function() {
        if(confirm("G√ºn√º kapatƒ±p ciroyu sƒ±fƒ±rlƒ±yor musun?")) { remove(ref(db, 'arsiv')).then(() => { alert("Sƒ±fƒ±rlandƒ±!"); window.raporlariAc(); }); }
    }
// --- BU KISIM SCRIPT TYPE="MODULE" ƒ∞√áƒ∞NE EN ALTA EKLENECEK ---
    
    window.saveCustomerDataDirectly = function(tel, isim, adres, sonSiparis) {
        set(ref(db, 'musteriler/' + tel), { 
            isim: isim, 
            adres: adres, 
            sonSiparis: sonSiparis 
        }).then(() => {
            alert("‚úÖ M√º≈üteri Ba≈üarƒ±yla Kaydedildi!");
            document.getElementById("customerFormModal").style.display = "none";
            if(window.openCustomerList) window.openCustomerList(); // Listeyi yenile
        });
    }

    window.deleteCustomerDataDirectly = function(tel) {
        remove(ref(db, 'musteriler/' + tel)).then(() => {
            alert("üóëÔ∏è M√º≈üteri Silindi.");
            if(window.openCustomerList) window.openCustomerList(); // Listeyi yenile
        });
    }
</script>
<div id="customerFormModal" class="modal" style="z-index: 2200;">
    <div class="modal-content">
        <h3 id="custFormTitle" style="color:var(--primary); margin-top:0;">M√º≈üteri Ekle</h3>
        
        <label style="font-weight:bold; font-size:13px; color:#666;">Telefon Numarasƒ±:</label>
        <input type="tel" id="custFormTel" class="search-input" placeholder="5XXXXXXXXX" style="margin-bottom:15px;">
        
        <label style="font-weight:bold; font-size:13px; color:#666;">M√º≈üteri Adƒ±:</label>
        <input type="text" id="custFormName" class="search-input" placeholder="Ad Soyad" style="margin-bottom:15px;">
        
        <label style="font-weight:bold; font-size:13px; color:#666;">Adres:</label>
        <textarea id="custFormAddr" class="search-input" rows="4" placeholder="Tam Adres..."></textarea>
        
        <button class="action-btn-full" style="background:var(--success)" onclick="saveCustomerToDb()">KAYDET</button>
        <button class="action-btn-full" style="background:#e2e8f0; color:#333" onclick="document.getElementById('customerFormModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>
</body>
</html>
