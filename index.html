<!DOCTYPE html>
<html lang="tr">
<head>
<script>
  // Gƒ∞Rƒ∞≈û KONTROL√ú (LOCALSTORAGE) - Bu kƒ±sƒ±m uygulamanƒ±n genel kilididir.
  if (localStorage.getItem("mutenaGiris") !== "true") {
    var password = prompt("L√ºtfen giri≈ü ≈üifresini yazƒ±n:");
    if (password === "mutena123") {
      localStorage.setItem("mutenaGiris", "true");
      alert("Giri≈ü ba≈üarƒ±lƒ±!");
    } else {
      alert("Hatalƒ± ≈üifre!");
      window.location.href = "https://google.com";
    }
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mutena Dijital Adisyon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- MODERN UI DEƒûƒ∞≈ûKENLERƒ∞ --- */
        :root {
            --primary: #1e293b;       /* Koyu Lacivert */
            --secondary: #34495e;     /* Gri Mavi */
            --accent: #f39c12;        /* Canlƒ± Turuncu */
            --accent-hover: #d35400;  /* Koyu Turuncu */
            --success: #27ae60;       /* Ye≈üil */
            --danger: #e74c3c;        /* Kƒ±rmƒ±zƒ± */
            --bg-body: #f4f6f8;       /* A√ßƒ±k Gri Arkaplan */
            --bg-card: #ffffff;       /* Kart Beyazƒ± */
            --text-main: #2d3436;
            --text-light: #636e72;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-hard: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- GENEL AYARLAR --- */
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-top: 75px; /* Header bo≈üluƒüu */
            padding-bottom: 30px;
        }

        /* --- HEADER --- */
        header { 
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            color: #f1c40f; 
            padding: 15px 20px; 
            text-align: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
            position: fixed; 
            top: 0; left: 0; width: 100%; 
            z-index: 1000;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        h1 { margin: 0; font-weight: 800; font-size: 20px; letter-spacing: 1px; text-transform: uppercase; }
        
        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        .mode-selector { 
            display: flex; flex-direction: column; justify-content: center; gap: 20px; padding: 30px; 
            min-height: 90vh; align-items: center; 
            background: linear-gradient(135deg, #1e293b, #2c3e50);
            margin-top: -75px;
        }
        .mode-btn { 
            width: 100%; max-width: 380px; padding: 25px; font-size: 18px; cursor: pointer; border: none; 
            border-radius: var(--radius-lg); color: white; font-weight: 700; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .mode-btn:active { transform: scale(0.97); }
        .mode-btn i { font-size: 24px; opacity: 0.9; }
        
        /* Buton Renkleri (Gradyan) */
        .btn-garson-alt { background: linear-gradient(135deg, #f39c12, #d35400); }
        .btn-garson-ust { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .btn-mutfak { background: linear-gradient(135deg, #e74c3c, #c0392b); } 
        .btn-kasa { background: linear-gradient(135deg, #2ecc71, #27ae60); }

        /* --- PANELLER --- */
        #garson-panel, #kasa-panel, #mutfak-panel, #rapor-panel { 
            display: none; padding: 15px; max-width: 800px; margin: 0 auto; padding-bottom: 140px;
        }
        
        /* --- GARSON KONTROLLERƒ∞ --- */
        .garson-header { 
            position: sticky; top: 75px; z-index: 800; 
            background: var(--bg-body); 
            padding: 10px 0; 
            margin-bottom: 10px;
        }
        .garson-controls { display: flex; gap: 10px; }
        
        .table-select, .search-input { 
            flex: 1; padding: 15px; font-size: 16px; 
            border: 2px solid #e2e8f0; border-radius: var(--radius-md); 
            font-weight: 600; background: white; color: var(--text-main);
            box-shadow: var(--shadow-soft); outline: none; appearance: none;
            transition: border-color 0.3s;
        }
        .table-select:focus, .search-input:focus { border-color: var(--info-color); }
        
        option.busy-table { background-color: #fff3cd; color: #d35400; font-weight: bold; }
        
        #masaDurumBilgisi {
            background-color: #fff8e1; color: #856404; padding: 15px; margin-top: 10px; 
            border-radius: var(--radius-md); border-left: 5px solid #ffc107; 
            display: none; font-size: 14px; box-shadow: var(--shadow-soft);
        }

        /* --- MEN√ú KATEGORƒ∞LERƒ∞ (AKORDEON) --- */
        .category-wrapper { margin-bottom: 12px; }
        .category-title { 
            background: white; color: var(--primary); padding: 18px 20px; 
            border-radius: var(--radius-md); font-weight: 700; font-size: 16px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-soft); border: 1px solid transparent;
            transition: all 0.2s;
        }
        .category-title:active { background-color: #f8fafc; transform: scale(0.99); }
        .category-title span:last-child { color: var(--accent); font-size: 12px; }

        .category-items {
            display: none; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; padding: 15px 5px;
            animation: fadeIn 0.3s ease;
        }
        @media (min-width: 600px) { .category-items { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-item { 
            background: white; padding: 15px; border-radius: var(--radius-md); 
            text-align: center; border: 1px solid #f1f5f9;
            box-shadow: var(--shadow-soft); 
            display: flex; flex-direction: column; justify-content: space-between; 
            min-height: 100px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .menu-item:active { transform: scale(0.95); border-color: var(--accent); background-color: #fffbf2; }
        .menu-name { font-weight: 600; font-size: 15px; color: var(--text-main); margin-bottom: 8px; line-height: 1.3;}
        .menu-price { color: var(--accent-hover); font-weight: 800; font-size: 17px; }
        
        /* --- SEPET & BUTONLAR --- */
        .cart-section { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 15px 20px; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1); 
            z-index: 999; box-sizing: border-box; 
            display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .cart-total-info { font-size: 16px; font-weight: 700; color: var(--primary); }
        .cart-total-info span { color: var(--danger); font-size: 20px; }

        .cart-btn { 
            background: linear-gradient(to right, #27ae60, #2ecc71); 
            border: none; color: white; padding: 14px 30px; 
            border-radius: 50px; font-weight: 700; font-size: 15px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            transition: transform 0.2s;
        }
        .cart-btn:active { transform: scale(0.95); }

        /* --- MODALLER --- */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; backdrop-filter: blur(4px); }
        .modal-content { 
            background: var(--bg-card); width: 90%; max-width: 450px; 
            margin: 60px auto; padding: 25px; border-radius: var(--radius-lg); 
            max-height: 80vh; overflow-y: auto; position: relative; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Sepet Listesi */
        .modal-list { list-style: none; padding: 0; margin-bottom: 20px; }
        .modal-list li { 
            display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.3fr; 
            align-items: center; padding: 12px 0; 
            border-bottom: 1px solid #f1f5f9; gap: 10px;
        }
        .modal-list li span:first-child { font-weight: 600; color: var(--primary); font-size: 14px; }
        
        .portion-select { 
            padding: 8px 5px; border-radius: 8px; border: 1px solid #cbd5e1; 
            background: #f8fafc; font-weight: 600; font-size: 12px; width: 100%; outline: none;
        }
        
        .del-item { 
            background: #ffebee; color: var(--danger); 
            width: 32px; height: 32px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: background 0.2s;
        }
        .del-item:active { background: #ffcdd2; }

        .note-area { 
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; 
            border-radius: var(--radius-md); box-sizing: border-box; 
            font-family: inherit; margin-bottom: 15px; background: #f8fafc;
            outline: none; transition: border 0.3s;
        }
        .note-area:focus { border-color: var(--info-color); }

        .action-btn-full { width: 100%; padding: 15px; border: none; border-radius: var(--radius-md); font-weight: 700; font-size: 16px; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .action-btn-full:active { transform: scale(0.98); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2); }
        .btn-cancel { background: var(--danger); color: white; margin-top: 10px; }
        .btn-close { background: #e2e8f0; color: var(--text-light); }

        /* --- KASA G√ñR√úN√úM√ú --- */
        .floor-section { margin-bottom: 30px; }
        .floor-title { 
            font-size: 18px; font-weight: 800; color: white; 
            padding: 12px 20px; border-radius: var(--radius-md); 
            margin-bottom: 15px; display: inline-block; 
            box-shadow: var(--shadow-soft);
        }
        .bg-alt { background: var(--accent); }
        .bg-ust { background: var(--upper-floor-color); } /* Mor */

        .order-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        
        .order-card { 
            background: white; border-left: 6px solid #ccc; padding: 20px; 
            border-radius: var(--radius-md); box-shadow: var(--shadow-soft); 
            display: flex; flex-direction: column; transition: transform 0.2s;
        }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card-alt { border-left-color: var(--accent); }
        .card-ust { border-left-color: #8e44ad; }

        .order-header { display: flex; justify-content: space-between; font-weight: 800; font-size: 18px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px; color: var(--primary); }
        .order-list-container { max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px;}
        .order-list-compact li { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 5px; }
        
        .hazir-urun { color: #94a3b8; text-decoration: line-through; }
        .hazir-etiket { color: var(--success); font-size: 11px; font-weight: bold; background: #dcfce7; padding: 3px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }

        .total-price-compact { text-align: right; font-size: 20px; font-weight: 800; color: var(--success); margin-top: auto; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .edit-btn, .pay-btn { flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm); font-weight: 700; cursor: pointer; color: white; font-size: 14px; transition: opacity 0.2s;}
        .edit-btn { background: #f39c12; } 
        .pay-btn { background: #c0392b; }
        .edit-btn:hover, .pay-btn:hover { opacity: 0.9; }

        /* --- MUTFAK --- */
        .kitchen-card { border-left: 6px solid #d35400; background: #fffcf5; }
        .kitchen-item-ready { color: #95a5a6; text-decoration: line-through; opacity: 0.6; font-size: 15px; }
        .kitchen-item-new { color: var(--primary); font-weight: 800; font-size: 19px; padding: 5px 0; }
        .ready-btn { width: 100%; background: var(--success); color: white; padding: 15px; border: none; border-radius: var(--radius-md); font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }

        /* --- Mƒ∞Nƒ∞ SEPET (CANLI) --- */
        .mini-cart-container { 
            position: fixed; bottom: 85px; left: 15px; right: 15px; 
            background: rgba(255,255,255,0.98); 
            max-height: 150px; overflow-y: auto; z-index: 990; 
            display: none; padding: 10px; border-radius: var(--radius-md);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #e2e8f0;
        }
        .mini-cart-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: var(--text-main); font-weight: 500;}
        .mini-cart-item:last-child { border-bottom: none; }
        .mini-cart-remove { color: var(--danger); cursor: pointer; font-weight: bold; padding: 0 5px; }

        /* --- Y√ñNETƒ∞Cƒ∞ Gƒ∞Rƒ∞≈û ƒ∞NPUT --- */
        #kasaSifreInput { border: 2px solid #cbd5e1; border-radius: var(--radius-md); padding: 15px; font-size: 24px; width: 80%; letter-spacing: 5px; margin-bottom: 20px; outline: none; text-align: center; }
        
        /* --- BUTONLAR GENEL --- */
        .back-btn { background: #94a3b8; color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;}
        
        /* --- Y√ñNETƒ∞M --- */
        .menu-manage-table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; border-radius: var(--radius-sm); overflow: hidden; box-shadow: var(--shadow-soft); }
        .menu-manage-table th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        .menu-manage-table td { border-bottom: 1px solid #f1f5f9; padding: 12px; color: var(--text-main); }
        .drag-handle { cursor: grab; text-align: center; color: #94a3b8; font-size: 18px; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    </style>
</head>
<body>

<header>
    <h1>MUTENA ADƒ∞SYON</h1>
</header>

<div class="mode-selector" id="giris-ekrani">
    <button class="mode-btn btn-garson-alt" onclick="openMode('garson-alt')">
        <i class="fas fa-utensils"></i> ALT KAT GARSON (61-68)
    </button>
    <button class="mode-btn btn-garson-ust" onclick="openMode('garson-ust')">
        <i class="fas fa-layer-group"></i> √úST KAT GARSON (1-18)
    </button>
    <button class="mode-btn btn-mutfak" onclick="openMode('mutfak')">
        <i class="fas fa-fire-alt"></i> MUTFAK EKRANI
    </button>
    <button class="mode-btn btn-kasa" onclick="openMode('kasa')">
        <i class="fas fa-cash-register"></i> KASA Gƒ∞Rƒ∞≈ûƒ∞ üîí
    </button>
</div>

<div id="passwordModal" class="modal" style="z-index: 2000;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-lock" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Y√∂netici Giri≈üi</h3>
        <input type="password" id="kasaSifreInput" placeholder="****" inputmode="numeric">
        <button class="action-btn-full btn-success" onclick="sifreKontrolEt()">Gƒ∞Rƒ∞≈û YAP</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="passwordChangeModal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="text-align: center;">
        <i class="fas fa-key" style="font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
        <h3 style="margin-top:0">Kasa ≈ûifresini Deƒüi≈ütir</h3>
        
        <input type="password" id="eskiSifreInput" placeholder="Mevcut ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        <input type="text" id="yeniSifreInput" placeholder="Yeni ≈ûifre" class="note-area" style="text-align:center; font-size:18px;" inputmode="numeric">
        
        <button class="action-btn-full btn-success" onclick="sifreyiVeritabanindaGuncelle()">KAYDET VE DEƒûƒ∞≈ûTƒ∞R</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('passwordChangeModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="porsiyonModal" class="modal" style="z-index: 1500;">
    <div class="modal-content" style="text-align: center;">
        <h3 id="porsiyonUrunAdi" style="color:var(--primary);">√úr√ºn Se√ßildi</h3>
        <p>L√ºtfen porsiyon miktarƒ±nƒ± se√ßiniz:</p>
        <button class="action-btn-full btn-close" style="margin-top:10px;" onclick="document.getElementById('porsiyonModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="garson-panel">
    <button class="back-btn" onclick="location.reload()">
        <i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü
    </button>
    
    <div class="garson-header">
        <div class="garson-controls">
            <select id="masaSecimi" class="table-select" onchange="masaKontrol()">
                </select>
            <input type="text" id="urunArama" class="search-input" placeholder="üîç √úr√ºn Ara..." onkeyup="urunAra()">
        </div>
        <div id="masaDurumBilgisi"></div>
    </div>

    <div id="menuContainer" style="padding-bottom: 20px;"></div>
    
    <div id="miniCart" class="mini-cart-container"></div>

    <div class="cart-section" onclick="sepetiAc()">
        <div class="cart-total-info">Toplam: <span id="sepetToplam">0</span> ‚Ç∫</div>
        <button class="cart-btn">SEPETƒ∞ ONAYLA <i class="fas fa-check"></i></button>
    </div>
</div>

<div id="sepetModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
            <i class="fas fa-shopping-basket"></i> Sipari≈ü √ñzeti
        </h3>
        <ul id="sepetListesi" class="modal-list"></ul>
        <textarea id="siparisNotu" class="note-area" rows="2" placeholder="Not ekle (√ñrn: Acƒ±sƒ±z, Soƒüansƒ±z)..."></textarea>
        <button class="action-btn-full btn-success" onclick="firebasedenGonder()">‚úÖ Sƒ∞PARƒ∞≈ûƒ∞ G√ñNDER</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('sepetModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="mutfak-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="font-weight:800; color:#d35400; font-size:24px; letter-spacing:1px;">
            <i class="fas fa-fire"></i> MUTFAK
        </div>
    </div>
    <div id="mutfakSiparisContainer" class="order-container"></div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Sipari≈üi D√ºzenle</h3>
        <h4 id="editMasaBaslik" style="color:var(--text-light); margin-bottom:15px;"></h4>
        <ul id="editList" class="modal-list" style="max-height:200px; overflow-y:auto;"></ul>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <select id="editMenuSelect" class="table-select" style="padding:10px;"></select>
            <button onclick="editUrunEkle()" style="padding:10px 20px; background:var(--info-color); color:white; border:none; border-radius:8px; font-weight:bold;">EKLE</button>
        </div>
        <div style="text-align:right; font-weight:bold; margin:20px 0; font-size:18px; color:var(--success);">Yeni Toplam: <span id="editTotal">0</span> ‚Ç∫</div>
        <button class="action-btn-full btn-success" onclick="editKaydet()">DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
        <button class="action-btn-full btn-cancel" onclick="editSiparisiIptal()">üóëÔ∏è Sƒ∞PARƒ∞≈ûƒ∞ KOMPLE ƒ∞PTAL ET</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('editModal').style.display='none'">ƒ∞ptal</button>
    </div>
</div>

<div id="menuManageModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
        <h3>Men√º Y√∂netimi</h3>
        <p style="font-size:13px; color:var(--text-light); margin-bottom:15px;"><i class="fas fa-info-circle"></i> Sƒ±ralamak i√ßin <b>‚ò∞</b> simgesinden tutup s√ºr√ºkleyin.</p>
        <select id="filterCategory" class="table-select" style="padding:10px; margin-bottom:15px;" onchange="renderMenuManageTable()">
            <option value="all">üîç T√úM KATEGORƒ∞LER</option>
        </select>
        <div style="max-height:50vh; overflow-y:auto; border-radius:var(--radius-sm); border:1px solid #e2e8f0;">
            <table class="menu-manage-table">
                <thead><tr><th style="width:40px;">‚ò∞</th><th>Kategori</th><th>√úr√ºn</th><th>Fiyat</th><th>Sil</th></tr></thead>
                <tbody id="menuManageBody"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="addNewMenuRow()" class="action-btn-full" style="background:var(--info-color); color:white;">+ YENƒ∞ √úR√úN</button>
            <button onclick="addNewCategory()" class="action-btn-full" style="background:#9b59b6; color:white;">+ YENƒ∞ KATEGORƒ∞</button>
        </div>
        <button class="action-btn-full btn-success" style="margin-top:10px;" onclick="saveMenuChanges()">KAYDET VE √áIK</button>
        <button class="action-btn-full btn-close" onclick="document.getElementById('menuManageModal').style.display='none'">Kapat</button>
    </div>
</div>

<div id="kasa-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <button class="back-btn" onclick="location.reload()"><i class="fas fa-arrow-left"></i> √áƒ±kƒ±≈ü</button>
        <div style="display:flex; gap:10px;">
             <button onclick="openPasswordChangeModal()" style="background:#e67e22; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-key"></i> ≈ûƒ∞FRE</button>
            <button onclick="openMenuManager()" style="background:#3498db; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-edit"></i> MEN√ú</button>
            <button onclick="raporlariAc()" style="background:#9b59b6; color:white; border:none; padding:12px 20px; border-radius:var(--radius-md); font-weight:bold; cursor:pointer;"><i class="fas fa-chart-pie"></i> RAPOR</button>
        </div>
    </div>
    
    <div id="kasaContainer"></div>
</div>

<div id="rapor-panel">
    <button class="back-btn" onclick="openMode('kasa-authorized')" style="margin-bottom:20px;">‚Üê Geri</button>
    <div class="report-card">
        <div style="color:var(--text-light); font-weight:600;">BUG√úNK√ú Cƒ∞RO</div>
        <div class="report-value" id="gunlukCiro">0 ‚Ç∫</div>
    </div>
    <div class="report-card">
        <div style="color:var(--text-light); font-weight:600;">ƒ∞≈ûLEM SAYISI</div>
        <div class="report-value" id="toplamMasa">0</div>
    </div>
    <div class="report-card" style="text-align:left;">
        <h4 style="margin-top:0; border-bottom:2px solid #f1f5f9; padding-bottom:10px;">Satƒ±lan √úr√ºnler</h4>
        <ul id="satilanUrunlerListesi" style="padding-left:0; margin:0; font-size:14px; list-style:none;"></ul>
    </div>
    <button class="action-btn-full btn-cancel" onclick="raporlariSifirla()"><i class="fas fa-trash-alt"></i> Cƒ∞ROYU SIFIRLA</button>
</div>

<script>
    // MASALAR
    const TABLES_ALT = ["Masa 61", "Masa 62", "Masa 63", "Masa 64", "Masa 65", "Masa 66", "Masa 67", "Masa 68"];
    const TABLES_UST = Array.from({length: 18}, (_, i) => `Masa ${i + 1}`); 

    let CATEGORIES = ["G√úN√úN YEMEKLERƒ∞", "√áORBALAR", "IZGARALAR", "AK√áAABAT K√ñFTE", "KUZU TANDIR", "Pƒ∞DELER", "KEBAPLAR", "TAVUK D√ñNER", "ET D√ñNER", "SALATALAR", "GARNƒ∞T√úR" , "ƒ∞√áECEKLER", "TATLI", "Dƒ∞ƒûER" , "BALIK"];
    
    const defaultMenuData = [
        { cat: "G√úN√úN YEMEKLERƒ∞", ad: "Kuru Fas√ºlye", fiyat: 180 },
        { cat: "G√úN√úN YEMEKLERƒ∞", ad: "Pirin√ß Pilavƒ±", fiyat: 80 },
        { cat: "G√úN√úN YEMEKLERƒ∞", ad: "Kuzu Ha≈ülama", fiyat: 300 },
        { cat: "G√úN√úN YEMEKLERƒ∞", ad: "Et Kavurma", fiyat: 300 },
        { cat: "√áORBALAR", ad: "Pa√ßa (Az)", fiyat: 100 },
        { cat: "√áORBALAR", ad: "Pa√ßa (Tam)", fiyat: 150 },
        { cat: "√áORBALAR", ad: "ƒ∞≈ükembe (Az)", fiyat: 100 },
        { cat: "√áORBALAR", ad: "ƒ∞≈ükembe (Tam)", fiyat: 150 },
        { cat: "IZGARALAR", ad: "Kuzu ≈ûi≈ü (Az)", fiyat: 200 },
        { cat: "IZGARALAR", ad: "Kuzu ≈ûi≈ü", fiyat: 350 },
        { cat: "IZGARALAR", ad: "Karƒ±≈üƒ±k Izgara", fiyat: 600 },
        { cat: "KEBAPLAR", ad: "Adana Kebap", fiyat: 300 },
        { cat: "ƒ∞√áECEKLER", ad: "Ayran", fiyat: 35 },
        { cat: "ƒ∞√áECEKLER", ad: "Su", fiyat: 10 }
    ];

    let currentMenu = []; 
    let sepet = [];
    let activeOrders = {};
    let editingOrderKey = null;
    let editingItems = [];
    let selectedUrunForPortion = null;

    function openMode(mode) {
        if (mode === 'kasa') {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('kasaSifreInput').value = '';
            document.getElementById('kasaSifreInput').focus();
            return;
        }
        
        document.getElementById("giris-ekrani").style.display = "none";
        document.getElementById("garson-panel").style.display = "none";
        document.getElementById("kasa-panel").style.display = "none";
        document.getElementById("mutfak-panel").style.display = "none";
        document.getElementById("rapor-panel").style.display = "none";
        
        if (mode === 'garson-alt') {
            document.getElementById("garson-panel").style.display = "block";
            updateTableSelect(TABLES_ALT);
            if(window.fetchMenu) window.fetchMenu();
            if(window.garsonMasalariDinle) window.garsonMasalariDinle();
        } 
        else if (mode === 'garson-ust') {
            document.getElementById("garson-panel").style.display = "block";
            updateTableSelect(TABLES_UST);
            if(window.fetchMenu) window.fetchMenu();
            if(window.garsonMasalariDinle) window.garsonMasalariDinle();
        }
        else if (mode === 'mutfak') {
            document.getElementById("mutfak-panel").style.display = "block";
            if(window.mutfakSiparisleriDinle) window.mutfakSiparisleriDinle();
        }
        else if (mode === 'kasa-authorized') { 
            document.getElementById("kasa-panel").style.display = "block";
            if(window.siparisleriGetir) window.siparisleriGetir();
            if(window.fetchMenu) window.fetchMenu();
        }
    }

    function updateTableSelect(tables) {
        const select = document.getElementById("masaSecimi");
        select.innerHTML = '<option value="">MASA SE√áƒ∞Nƒ∞Z...</option>';
        tables.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.text = t;
            select.appendChild(opt);
        });
        if(window.garsonMasalariDinle) window.garsonMasalariDinle();
    }

    // --- ≈ûƒ∞FRE KONTROL√ú (G√úNCELLENDƒ∞) ---
    window.sifreKontrolEt = function() {
        const input = document.getElementById("kasaSifreInput").value;
        // Eƒüer veritabanƒ±ndan hen√ºz ≈üifre gelmediyse "1234" varsayƒ±landƒ±r.
        // window.currentKasaSifre deƒüi≈ükeni a≈üaƒüƒ±da Firebase'den doldurulur.
        const gecerliSifre = window.currentKasaSifre || "1234";

        if(input === gecerliSifre) {
            document.getElementById('passwordModal').style.display = 'none';
            openMode('kasa-authorized');
        } else {
            alert("‚õî Hatalƒ± ≈ûifre!");
            document.getElementById("kasaSifreInput").value = "";
        }
    }
    
    // --- ≈ûƒ∞FRE DEƒûƒ∞≈ûTƒ∞RME UI FONKSƒ∞YONLARI (YENƒ∞) ---
    window.openPasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').style.display = 'block';
        document.getElementById('eskiSifreInput').value = '';
        document.getElementById('yeniSifreInput').value = '';
    }

    window.sifreyiVeritabanindaGuncelle = function() {
        const eski = document.getElementById('eskiSifreInput').value;
        const yeni = document.getElementById('yeniSifreInput').value;
        const mevcut = window.currentKasaSifre || "1234";

        if(eski !== mevcut) {
            alert("‚ùå Mevcut ≈üifreyi yanlƒ±≈ü girdiniz!");
            return;
        }

        if(yeni.length < 4) {
            alert("‚ö†Ô∏è Yeni ≈üifre en az 4 karakter olmalƒ±dƒ±r.");
            return;
        }

        // Firebase fonksiyonunu √ßaƒüƒ±r
        if(window.saveNewPasswordToFirebase) {
            window.saveNewPasswordToFirebase(yeni);
        } else {
            alert("Veritabanƒ± baƒülantƒ±sƒ± bekleniyor...");
        }
    }


    function masaKontrol() {
        const masa = document.getElementById("masaSecimi").value;
        const durumDiv = document.getElementById("masaDurumBilgisi");
        const aktifSiparis = Object.values(activeOrders).find(o => o.masa === masa);
        if (aktifSiparis) {
            let icerik = "<strong>Bu Masadaki √úr√ºnler:</strong><br>";
            if(aktifSiparis.urunler) aktifSiparis.urunler.forEach(u => icerik += `- ${u.ad}<br>`);
            icerik += `<br><strong>Toplam: ${aktifSiparis.toplam} ‚Ç∫</strong>`;
            durumDiv.innerHTML = icerik;
            durumDiv.style.display = "block";
        } else {
            durumDiv.style.display = "none";
        }
    }

    // A√áILIR/KAPANIR MEN√ú FONKSƒ∞YONU
    window.renderMenu = function(menuList) {
        currentMenu = menuList; 
        const container = document.getElementById("menuContainer");
        container.innerHTML = "";
        
        const grouped = {};
        menuList.forEach(item => {
            if(!grouped[item.cat]) grouped[item.cat] = [];
            grouped[item.cat].push(item);
        });

        for (const [kategori, urunler] of Object.entries(grouped)) {
            const catBlock = document.createElement("div");
            catBlock.className = "category-wrapper";
            catBlock.style.marginBottom = "10px";

            const title = document.createElement("div");
            title.className = "category-title";
            title.innerHTML = `<span>${kategori}</span> <span style="font-size:12px">‚ñº</span>`;
            
            const itemsContainer = document.createElement("div");
            itemsContainer.className = "category-items"; 
            
            urunler.forEach(urun => {
                const div = document.createElement("div");
                div.className = "menu-item";
                div.innerHTML = `<div class="menu-name">${urun.ad}</div><div class="menu-price">${urun.fiyat} ‚Ç∫</div>`;
                // Dƒ∞REKT EKLEME (Porsiyon sepette se√ßilecek)
                div.onclick = () => sepeteEkle(urun);
                itemsContainer.appendChild(div);
            });

            title.onclick = function() {
                const isCurrentlyOpen = itemsContainer.style.display === "grid";
                document.querySelectorAll('.category-items').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.category-title span:last-child').forEach(el => el.innerText = '‚ñº');
                
                if (!isCurrentlyOpen) {
                    itemsContainer.style.display = "grid";
                    this.querySelector('span:last-child').innerText = "‚ñ≤";
                }
            };

            catBlock.appendChild(title);
            catBlock.appendChild(itemsContainer);
            container.appendChild(catBlock);
        }
    }

    // √úR√úN ARAMA
    window.urunAra = function() {
        const input = document.getElementById("urunArama");
        const filter = input.value.toUpperCase();
        const wrappers = document.getElementsByClassName("category-wrapper");

        if (filter === "") {
            window.renderMenu(currentMenu);
            return;
        }

        for (let i = 0; i < wrappers.length; i++) {
            const wrapper = wrappers[i];
            const itemsContainer = wrapper.getElementsByClassName("category-items")[0];
            const items = itemsContainer.getElementsByClassName("menu-item");
            let hasMatch = false;

            for (let j = 0; j < items.length; j++) {
                const item = items[j];
                const name = item.getElementsByClassName("menu-name")[0];
                if (name.innerText.toUpperCase().indexOf(filter) > -1) {
                    item.style.display = "flex";
                    hasMatch = true;
                } else {
                    item.style.display = "none";
                }
            }

            if (hasMatch) {
                wrapper.style.display = "";
                itemsContainer.style.display = "grid";
                wrapper.querySelector('.category-title span:last-child').innerText = '‚ñ≤';
            } else {
                wrapper.style.display = "none";
            }
        }
    }

    function initEditDropdown() {
        const select = document.getElementById("editMenuSelect");
        select.innerHTML = '<option value="">√úr√ºn Se√ßiniz...</option>';
        currentMenu.sort((a, b) => a.cat.localeCompare(b.cat));
        currentMenu.forEach(item => {
            const option = document.createElement("option");
            option.value = JSON.stringify(item);
            option.text = `${item.cat} - ${item.ad} (${item.fiyat} ‚Ç∫)`;
            select.appendChild(option);
        });
    }

    // --- SEPET & PORSƒ∞YON ƒ∞≈ûLEMLERƒ∞ ---

    function sepeteEkle(urun) { 
        let eklenecekUrun = { ...urun, porsiyon: 1, baseFiyat: urun.fiyat };
        sepet.push(eklenecekUrun); 
        sepetiGuncelle(); 
    }

    window.porsiyonDegistir = function(index, yeniPorsiyon) {
        let urun = sepet[index];
        urun.porsiyon = parseFloat(yeniPorsiyon);
        urun.fiyat = urun.baseFiyat * urun.porsiyon;
        
        let temizAd = urun.ad.split(" (")[0]; 
        if (urun.porsiyon !== 1) {
            urun.ad = `${temizAd} (${urun.porsiyon} Pors.)`;
        } else {
            urun.ad = temizAd;
        }
        sepetiGuncelle();
    }

    function sepetiGuncelle() {
        const toplamSpan = document.getElementById("sepetToplam");
        const detayListe = document.getElementById("sepetListesi");
        const miniCart = document.getElementById("miniCart"); 
        
        detayListe.innerHTML = "";
        miniCart.innerHTML = ""; 
        let toplam = 0;

        if (sepet.length > 0) {
            miniCart.style.display = "block"; 
            const ul = document.createElement("ul");
            ul.className = "mini-cart-list";

            sepet.forEach((item, index) => {
                toplam += item.fiyat;
                
                let optionsHTML = "";
                for (let p = 1; p <= 5; p += 0.5) {
                    let selected = item.porsiyon === p ? "selected" : "";
                    optionsHTML += `<option value="${p}" ${selected}>${p} Porsiyon</option>`;
                }

                // Modal Listesi
                const li = document.createElement("li");
                li.innerHTML = `
                    <span>${item.ad.split(" (")[0]}</span> 
                    <select class="portion-select" onchange="porsiyonDegistir(${index}, this.value)">
                        ${optionsHTML}
                    </select>
                    <span style="font-weight:bold; color:var(--danger); text-align:right;">${item.fiyat}‚Ç∫</span> 
                    <div class="del-item" onclick="sepettenCikar(${index})"><i class="fas fa-times"></i></div>
                `;
                detayListe.appendChild(li);

                // Mini Sepet (Canlƒ±)
                const miniLi = document.createElement("li");
                miniLi.className = "mini-cart-item";
                miniLi.innerHTML = `
                    <span>${item.ad}</span> 
                    <div class="mini-cart-remove" onclick="sepettenCikar(${index})"><i class="fas fa-times"></i></div>
                `;
                ul.appendChild(miniLi);
            });
            miniCart.appendChild(ul);
        } else {
            miniCart.style.display = "none"; 
        }
        toplamSpan.textContent = toplam;
    }

    function sepetiAc() { if(sepet.length > 0) document.getElementById("sepetModal").style.display = "block"; }
    
    function sepettenCikar(index) { 
        sepet.splice(index, 1); 
        sepetiGuncelle(); 
        if(sepet.length === 0) document.getElementById("sepetModal").style.display = "none"; 
    }

    function firebasedenGonder() {
        if(!window.sendOrder) { alert("Sistem y√ºkleniyor, l√ºtfen bekleyin..."); return; }
        const masa = document.getElementById("masaSecimi").value;
        const not = document.getElementById("siparisNotu").value;
        if (!masa) { alert("Masa se√ßilmedi!"); return; }
        
        const existingKey = Object.keys(activeOrders).find(key => activeOrders[key].masa === masa);
        if (existingKey) {
            const oldOrder = activeOrders[existingKey];
            const newItems = oldOrder.urunler ? [...oldOrder.urunler, ...sepet] : [...sepet];
            const newTotal = newItems.reduce((a, b) => a + b.fiyat, 0);
            window.updateOrderInFirebase(existingKey, newItems, newTotal, 'hazirlaniyor', () => { resetAfterSend(); });
        } else {
            window.sendOrder(masa, sepet, not, () => { resetAfterSend(); });
        }
    }
    function resetAfterSend() {
        sepet = [];
        sepetiGuncelle();
        document.getElementById("sepetModal").style.display = "none";
        document.getElementById("masaSecimi").value = "";
        document.getElementById("siparisNotu").value = "";
        document.getElementById("masaDurumBilgisi").style.display = "none";
        window.scrollTo(0,0);
    }

    // --- Dƒ∞ƒûER FONKSƒ∞YONLAR ---

    window.siparisDuzenle = function(key) {
        const order = activeOrders[key];
        if(!order) return;
        editingOrderKey = key;
        editingItems = [...order.urunler]; 
        document.getElementById("editMasaBaslik").textContent = order.masa + " D√ºzenleniyor";
        initEditDropdown(); renderEditList();
        document.getElementById("editModal").style.display = "block";
    }
    function renderEditList() {
        const list = document.getElementById("editList");
        const totalSpan = document.getElementById("editTotal");
        list.innerHTML = "";
        let total = 0;
        editingItems.forEach((item, index) => {
            total += item.fiyat;
            const li = document.createElement("li");
            li.innerHTML = `<span>${item.ad}</span> <div style="display:flex; align-items:center; gap:10px;"><span style="font-weight:bold; color:#e74c3c;">${item.fiyat}‚Ç∫</span><div class="del-item" onclick="editUrunSil(${index})"><i class="fas fa-trash"></i></div></div>`;
            list.appendChild(li);
        });
        totalSpan.textContent = total;
    }
    window.editUrunSil = function(index) { editingItems.splice(index, 1); renderEditList(); }
    window.editUrunEkle = function() {
        const select = document.getElementById("editMenuSelect");
        if(select.value === "") return;
        const item = JSON.parse(select.value);
        editingItems.push(item);
        renderEditList();
    }
    window.editKaydet = function() {
        if(!window.updateOrderInFirebase) return;
        if(confirm("Deƒüi≈üiklikler kaydedilsin mi?")) {
            const newTotal = editingItems.reduce((acc, item) => acc + item.fiyat, 0);
            window.updateOrderInFirebase(editingOrderKey, editingItems, newTotal, 'hazirlaniyor', () => { document.getElementById("editModal").style.display = "none"; });
        }
    }
    window.editSiparisiIptal = function() {
        if(confirm("Dƒ∞KKAT! Bu masa tamamen silinecek. Onaylƒ±yor musunuz?")) {
            window.cancelOrderInFirebase(editingOrderKey, () => { document.getElementById("editModal").style.display = "none"; });
        }
    }

    window.openMenuManager = function() {
        const filterSelect = document.getElementById("filterCategory");
        filterSelect.innerHTML = '<option value="all">üîç T√úM KATEGORƒ∞LER</option>';
        CATEGORIES.forEach(cat => { filterSelect.innerHTML += `<option value="${cat}">${cat}</option>`; });
        renderMenuManageTable();
        document.getElementById("menuManageModal").style.display = "block";
        const tbody = document.getElementById("menuManageBody");
        new Sortable(tbody, { handle: '.drag-handle', animation: 150, onEnd: function (evt) { updateMenuOrderFromDOM(); } });
    }

    function renderMenuManageTable() {
        const tbody = document.getElementById("menuManageBody");
        const filter = document.getElementById("filterCategory").value;
        tbody.innerHTML = "";
        let catOptions = "";
        CATEGORIES.forEach(c => { catOptions += `<option value="${c}">${c}</option>`; });
        currentMenu.forEach((item, index) => {
            if(filter !== 'all' && item.cat !== filter) return;
            const tr = document.createElement("tr");
            tr.setAttribute("data-index", index); 
            let categorySelect = `<select class="cat-select" onchange="updateMenuItem(${index}, 'cat', this.value)">`;
            CATEGORIES.forEach(c => { categorySelect += `<option value="${c}" ${c === item.cat ? 'selected' : ''}>${c}</option>`; });
            categorySelect += `</select>`;
            tr.innerHTML = `<td class="drag-handle">‚ò∞</td><td>${categorySelect}</td><td><input type="text" class="menu-input" value="${item.ad}" onchange="updateMenuItem(${index}, 'ad', this.value)"></td><td><input type="number" class="menu-input" value="${item.fiyat}" onchange="updateMenuItem(${index}, 'fiyat', this.value)"></td><td style="text-align:center;"><span class="del-item" onclick="deleteMenuItem(${index})">X</span></td>`;
            tbody.appendChild(tr);
        });
    }

    function updateMenuOrderFromDOM() {
        const rows = document.querySelectorAll('#menuManageBody tr');
        const newOrderIndices = Array.from(rows).map(row => parseInt(row.getAttribute('data-index')));
        const availableSlots = [...newOrderIndices].sort((a, b) => a - b);
        const oldMenu = [...currentMenu];
        availableSlots.forEach((slotIndex, i) => { const oldIndex = newOrderIndices[i]; currentMenu[slotIndex] = oldMenu[oldIndex]; });
        renderMenuManageTable(); 
    }

    window.updateMenuItem = function(index, field, value) { if(field === 'fiyat') value = Number(value); currentMenu[index][field] = value; }
    window.deleteMenuItem = function(index) { if(confirm("Silmek istediƒüine emin misin?")) { currentMenu.splice(index, 1); renderMenuManageTable(); } }
    window.addNewMenuRow = function() {
        const filter = document.getElementById("filterCategory").value;
        const newCat = filter !== 'all' ? filter : CATEGORIES[0];
        currentMenu.push({ cat: newCat, ad: "Yeni √úr√ºn", fiyat: 0 });
        renderMenuManageTable();
    }
    
    window.addNewCategory = function() {
        const cat = prompt("Yeni Kategori Adƒ±:");
        if(cat && !CATEGORIES.includes(cat)) {
            CATEGORIES.push(cat);
            window.saveCategoriesToFirebase();
            renderMenuManageTable(); 
            const filterSelect = document.getElementById("filterCategory");
            filterSelect.innerHTML = '<option value="all">üîç T√úM KATEGORƒ∞LER</option>';
            CATEGORIES.forEach(cat => { filterSelect.innerHTML += `<option value="${cat}">${cat}</option>`; });
        }
    }

    window.saveMenuChanges = function() {
        if(confirm("Men√º deƒüi≈üikliƒüini onaylƒ±yor musunuz?")) {
            window.saveMenuToFirebase(currentMenu, () => {
                document.getElementById("menuManageModal").style.display = "none";
                renderMenu(currentMenu);
            });
        }
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, get, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCj9AGZsqvxMCmzrJDFUbj1teFd5st3IeQ",
        authDomain: "mutena-dijital-adisyon-becab.firebaseapp.com",
        databaseURL: "https://mutena-dijital-adisyon-becab-default-rtdb.firebaseio.com",
        projectId: "mutena-dijital-adisyon-becab",
        storageBucket: "mutena-dijital-adisyon-becab.firebasestorage.app",
        messagingSenderId: "68716658785",
        appId: "1:68716658785:web:ced487b01fe98a15b5aa20",
        measurementId: "G-26NWRGRVW4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- YENƒ∞ EKLENEN: ≈ûƒ∞FRE Y√ñNETƒ∞Mƒ∞ ---
    window.currentKasaSifre = "1234"; // Varsayƒ±lan

    // ≈ûifreyi veritabanƒ±ndan dinle
    const settingsRef = ref(db, 'settings/kasaSifresi');
    onValue(settingsRef, (snapshot) => {
        if (snapshot.exists()) {
            window.currentKasaSifre = snapshot.val().toString();
            console.log("Kasa ≈üifresi g√ºncellendi.");
        } else {
            // Veritabanƒ±nda ≈üifre yoksa varsayƒ±lanƒ± (1234) kaydet
            set(settingsRef, "1234");
        }
    });

    // ≈ûifreyi g√ºncelleme
    window.saveNewPasswordToFirebase = function(newPass) {
        set(settingsRef, newPass).then(() => {
            alert("‚úÖ ≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi! T√ºm cihazlarda ge√ßerli.");
            document.getElementById('passwordChangeModal').style.display = 'none';
        }).catch((error) => {
            alert("Hata olu≈ütu: " + error.message);
        });
    }
    // ------------------------------------

    window.fetchMenu = function() {
        const menuRef = ref(db, 'menu');
        get(menuRef).then((snapshot) => {
            if (snapshot.exists()) { window.renderMenu(snapshot.val()); } 
            else { set(menuRef, defaultMenuData); window.renderMenu(defaultMenuData); }
        });
        onValue(menuRef, (snapshot) => { if (snapshot.exists()) { window.renderMenu(snapshot.val()); } });
        get(ref(db, 'categories')).then(snap => {
            if(snap.exists()) CATEGORIES = snap.val();
            else set(ref(db, 'categories'), CATEGORIES);
        });
    }

    window.saveMenuToFirebase = function(newMenu, callback) {
        set(ref(db, 'menu'), newMenu).then(() => { alert("‚úÖ Men√º G√ºncellendi!"); callback(); });
    }
    
    window.saveCategoriesToFirebase = function() { set(ref(db, 'categories'), CATEGORIES); }

    window.sendOrder = function(masa, urunler, not, callback) {
        const siparisRef = ref(db, 'siparisler');
        const yeniSiparis = {
            masa: masa,
            urunler: urunler,
            not: not,
            durum: 'hazirlaniyor',
            toplam: urunler.reduce((a, b) => a + b.fiyat, 0),
            tarih: new Date().toLocaleDateString('tr-TR'),
            saat: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
        };
        push(siparisRef, yeniSiparis).then(() => { alert("‚úÖ Sipari≈ü ƒ∞letildi!"); callback(); });
    }

    window.updateOrderInFirebase = function(key, newItems, newTotal, status, callback) {
        const orderRef = ref(db, 'siparisler/' + key);
        update(orderRef, { urunler: newItems, toplam: newTotal, durum: status }).then(() => { alert("‚úÖ Sipari≈ü Eklendi/G√ºncellendi!"); callback(); });
    }

    window.cancelOrderInFirebase = function(key, callback) {
        remove(ref(db, 'siparisler/' + key)).then(() => { alert("üóëÔ∏è Sipari≈ü Silindi."); callback(); });
    }

    window.garsonMasalariDinle = function() {
        onValue(ref(db, 'siparisler'), (snapshot) => {
            const data = snapshot.val();
            activeOrders = data || {}; 
            const select = document.getElementById("masaSecimi");
            // Mevcut se√ßenekleri (Alt/√úst kat) koru ve g√ºncelle
            for (let i = 0; i < select.options.length; i++) {
                const opt = select.options[i];
                if (opt.value === "") continue;
                const isActive = Object.values(activeOrders).some(o => o.masa === opt.value);
                if(isActive) { 
                    opt.classList.add('busy-table'); 
                    if(!opt.text.includes("(DOLU)")) opt.text = opt.value + " (DOLU)"; 
                } else { 
                    opt.classList.remove('busy-table'); 
                    opt.text = opt.value; 
                }
            }
            if(select.value) masaKontrol();
        });
    }

    window.mutfakSiparisleriDinle = function() {
        onValue(ref(db, 'siparisler'), (snapshot) => {
            const data = snapshot.val();
            const container = document.getElementById("mutfakSiparisContainer");
            container.innerHTML = ""; 
            if (!data) { container.innerHTML = "<p style='text-align:center; color:#999; margin-top:80px; grid-column:1/-1; font-size:18px;'>Bekleyen sipari≈ü yok.</p>"; return; }
            Object.keys(data).forEach(key => {
                const siparis = data[key];
                if (siparis.durum === 'hazir') return;
                const yemekler = siparis.urunler ? siparis.urunler.filter(u => u.cat !== 'ƒ∞√áECEKLER') : [];
                if (yemekler.length === 0) return; 
                let urunHTML = "";
                yemekler.forEach(u => {
                    let porsiyonText = "";
                    if(u.porsiyon && u.porsiyon !== 1) {
                        porsiyonText = ` <span style='color:#e74c3c; font-weight:900;'>(${u.porsiyon} PORSƒ∞YON)</span>`;
                    }
                    let cleanName = u.ad.split(" (")[0];
                    if(u.hazir) {
                        urunHTML += `<li class="kitchen-item-ready">‚úÖ ${cleanName}${porsiyonText} <span style="font-size:12px; color:green; font-weight:bold;">(TESLƒ∞M EDƒ∞LDƒ∞)</span></li>`;
                    } else {
                        urunHTML += `<li class="kitchen-item-new">üî• ${cleanName}${porsiyonText}</li>`;
                    }
                });
                let notHTML = siparis.not ? `<div style='background:#fff3cd; padding:5px; margin-top:5px; border-radius:5px; font-size:14px;'>üìù ${siparis.not}</div>` : "";
                const div = document.createElement("div");
                div.className = "order-card kitchen-card";
                div.innerHTML = `<div class="order-header"><span>${siparis.masa}</span> <span style="font-size:16px;">${siparis.saat}</span></div><ul class="order-list-compact" style="margin-bottom:10px;">${urunHTML}</ul>${notHTML}<button class="ready-btn" onclick="siparisiHazirla('${key}')">T√úM√úN√ú HAZIRLA / TESLƒ∞M ET</button>`;
                container.appendChild(div);
            });
        });
    }

    window.siparisiHazirla = async function(key) {
        const snapshot = await get(ref(db, 'siparisler/' + key));
        if (snapshot.exists()) {
            const order = snapshot.val();
            const updatedProducts = order.urunler.map(u => {
                if(u.cat !== 'ƒ∞√áECEKLER') { return { ...u, hazir: true }; }
                return u;
            });
            const hazirSaat = new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
            update(ref(db, 'siparisler/' + key), { urunler: updatedProducts, durum: 'hazir', hazir_saat: hazirSaat });
        }
    }

    window.siparisleriGetir = function() {
        onValue(ref(db, 'siparisler'), (snapshot) => {
            const data = snapshot.val();
            const container = document.getElementById("kasaContainer");
            container.innerHTML = ""; 
            activeOrders = data || {}; 
            
            if (!data) { container.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>Sipari≈ü bekleniyor...</p>"; return; }

            // ƒ∞ki Ayrƒ± Konteyner Olu≈üturma (Alt ve √úst)
            const altKatDiv = document.createElement("div");
            altKatDiv.className = "floor-section";
            altKatDiv.innerHTML = '<div class="floor-title bg-alt">‚¨áÔ∏è ALT KAT (61-68)</div><div class="order-container" id="grid-alt"></div>';
            
            const ustKatDiv = document.createElement("div");
            ustKatDiv.className = "floor-section";
            ustKatDiv.innerHTML = '<div class="floor-title bg-ust">‚¨ÜÔ∏è √úST KAT (1-18)</div><div class="order-container" id="grid-ust"></div>';

            container.appendChild(altKatDiv);
            container.appendChild(ustKatDiv);

            const gridAlt = document.getElementById("grid-alt");
            const gridUst = document.getElementById("grid-ust");

            Object.keys(data).forEach(key => {
                const siparis = data[key];
                
                // Masa Numarasƒ±nƒ± Analiz Et
                let masaNo = parseInt(siparis.masa.replace("Masa ", ""));
                let targetGrid = null;
                let cardClass = "";

                if (masaNo >= 1 && masaNo <= 18) {
                    targetGrid = gridUst;
                    cardClass = "card-ust";
                } else {
                    targetGrid = gridAlt;
                    cardClass = "card-alt";
                }

                let urunHTML = "";
                if(siparis.urunler) siparis.urunler.forEach(u => { 
                    let porsiyonText = "";
                    if(u.porsiyon && u.porsiyon !== 1) { porsiyonText = ` (${u.porsiyon} Pors.)`; }
                    let readyTag = "";
                    if(u.hazir) { readyTag = ` <span class="hazir-etiket"><i class="fas fa-check"></i> Hazƒ±rlandƒ±</span>`; }
                    let itemClass = u.hazir ? "hazir-urun" : "";
                    urunHTML += `<li class="${itemClass}"><span>${u.ad.split(" (")[0]}${porsiyonText}${readyTag}</span> <span>${u.fiyat}‚Ç∫</span></li>`; 
                });

                let notHTML = siparis.not ? `<div style='background:#fff3cd; padding:5px; margin-top:5px; border-radius:5px; font-size:13px;'>üìù ${siparis.not}</div>` : "";
                let durumBadge = "";
                if(siparis.durum === 'hazir') { durumBadge = `<div style='color:green; font-weight:bold; font-size:14px; text-align:right;'>‚úÖ HAZIR: ${siparis.hazir_saat || ''}</div>`; } 
                else { durumBadge = "<div style='color:orange; font-weight:bold; font-size:14px; text-align:right;'>üî• HAZIRLANIYOR</div>"; }

                const div = document.createElement("div");
                div.className = `order-card ${cardClass}`;
                div.innerHTML = `<div class="order-header"><span>${siparis.masa}</span> <span style="font-size:13px; color:#888">${siparis.saat}</span></div>${durumBadge}<div class="order-list-container"><ul class="order-list-compact">${urunHTML}</ul></div>${notHTML}<div class="total-price-compact">TOPLAM: ${siparis.toplam} ‚Ç∫</div><div class="action-buttons"><button class="edit-btn" onclick="siparisDuzenle('${key}')">‚úèÔ∏è D√úZENLE</button><button class="pay-btn" onclick="hesabiKapat('${key}')">HESABI KAPAT</button></div>`;
                
                if(targetGrid) targetGrid.appendChild(div);
            });
        });
    }

    window.hesabiKapat = async function(key) {
        if(confirm("Hesap √∂dendi ve kapatƒ±lƒ±yor mu?")) {
            const snap = await get(ref(db, 'siparisler/' + key));
            if(snap.exists()) {
                await push(ref(db, 'arsiv'), snap.val());
                await remove(ref(db, 'siparisler/' + key));
            }
        }
    }

    window.raporlariAc = function() {
        document.getElementById("kasa-panel").style.display = "none";
        document.getElementById("rapor-panel").style.display = "block";
        get(ref(db, 'arsiv')).then((snapshot) => {
            if(snapshot.exists()) {
                const data = snapshot.val();
                let ciro = 0; let sayim = {}; let masaSayisi = 0;
                Object.values(data).forEach(s => {
                    ciro += s.toplam; masaSayisi++;
                    if(s.urunler) s.urunler.forEach(u => { 
                        let temizAd = u.ad.split(" (")[0];
                        sayim[temizAd] = (sayim[temizAd] || 0) + (u.porsiyon || 1); 
                    });
                });
                document.getElementById("gunlukCiro").innerText = ciro + " ‚Ç∫";
                document.getElementById("toplamMasa").innerText = masaSayisi;
                const liste = document.getElementById("satilanUrunlerListesi");
                liste.innerHTML = "";
                Object.entries(sayim).sort((a,b)=>b[1]-a[1]).forEach(([ad, adet]) => {
                    liste.innerHTML += `<li style='border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; font-size:14px;'><span>${ad}</span> <b>${adet} Pors.</b></li>`;
                });
            }
        });
    }

    window.raporlariSifirla = function() {
        if(confirm("Dƒ∞KKAT! Ciro sƒ±fƒ±rlanacak. Emin misin?")) {
            remove(ref(db, 'arsiv')).then(() => { alert("Sƒ±fƒ±rlandƒ±!"); window.raporlariAc(); });
        }
    }
</script>
</body>
</html>
